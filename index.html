<!-- 2025-09-29 19:26 JST | Version: V0.2.13-lite -->
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#0b1020">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>éŸ³èª­SURASURA V0.2.13-lite</title>
<style>
:root{--bg:#0b1020;--panel:#111827;--ink:#e6f1ff;--accent:#4f8cff;--ok:#20e3c2;--warn:#ffce3a;--bad:#ff6b6b}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Hiragino Kaku Gothic ProN,Meiryo,sans-serif}
header{position:sticky;top:0;background:linear-gradient(180deg,rgba(0,0,0,.5),transparent),var(--panel);padding:10px 14px;z-index:50}
h1{margin:0;font-size:18px}
.note{color:#9bb2d1;font-size:12px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#1e293b;color:#cfe6ff;border:1px solid #2a3a56;font-size:12px}
.wrapper{display:grid;gap:16px;padding:14px;max-width:980px;margin:0 auto}
.card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
input,select,button,textarea{background:#0c1322;color:var(--ink);border:1px solid #233047;border-radius:12px;padding:10px 12px;font-size:14px}
a.tab{color:#cfe6ff;text-decoration:none;border:1px solid #2a3a56;border-radius:999px;padding:6px 10px}
a.tab.active{background:#24324a}
.hidden{display:none!important}

/* landing */
.landing-cover{position:fixed;inset:0;z-index:2147483647;display:grid;place-items:center;background:#0b1020}
.landing-cover::before{content:"";position:absolute;inset:0;background:radial-gradient(80% 60% at 50% 10%,rgba(79,140,255,.15),transparent),linear-gradient(180deg,rgba(0,0,0,.85),rgba(0,0,0,.92))}
.landing-panel{position:relative;width:min(860px,94vw);border-radius:24px;background:var(--panel);border:1px solid #22324a;padding:22px}
.tilegrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:640px){.tilegrid{grid-template-columns:1fr}}
.tile{display:flex;align-items:center;justify-content:center;border-radius:18px;padding:18px;font-size:18px;border:2px solid rgba(255,255,255,.1);box-shadow:0 8px 20px rgba(0,0,0,.4);cursor:pointer;text-decoration:none;color:inherit}
.tile.stu{background:#4f8cff}
.tile.guard{background:#20e3c2;color:#06231d}
.tile.skip{background:#ffce3a;color:#261e00}
.tile.teach{background:#ff6b6b}
body.landing-active header,body.landing-active main{visibility:hidden}

/* student */
.tool-fixed{position:sticky;bottom:0;z-index:20;background:linear-gradient(180deg,transparent,rgba(0,0,0,.4)),#0b1020;padding:8px;border-radius:14px;border:1px solid #1f2b44;display:flex;gap:8px;justify-content:space-between}
.tool-fixed button{font-size:18px;padding:14px 18px;border-radius:14px;flex:1}
.btn-start{background:#36d399}.btn-pause{background:#60a5fa}.btn-stop{background:#fb7185}
#readingText{min-height:180px;font-size:28px;line-height:1.9;border:1px solid #233047;border-radius:14px;padding:14px;background:#0c1322}
.reading-anim{animation:wiggle 1.2s ease-in-out infinite}
@keyframes wiggle{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
.hl-miss{background:#3a1020;color:#ffd7de;border-bottom:1px dashed #ff6b6b}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #24324a;padding:8px;font-size:13px}
</style>
</head>
<body>
<header>
  <div style="display:flex;gap:12px;align-items:center">
    <div>
      <h1>éŸ³èª­SURASURA <small class="badge">V0.2.13-lite</small></h1>
      <div class="note">#/start=å…¥å£ï½œ#/s=ç”Ÿå¾’ï½œ#/t=è¬›å¸«ï½œ#/g=ä¿è­·è€…ï¼ˆPWï¼‰ï½œ?debug=1ã§ãƒ­ã‚°</div>
    </div>
    <nav class="tabnav" style="margin-left:auto;display:flex;gap:8px">
      <a id="tabS" href="#/s" class="tab">ç”Ÿå¾’</a>
      <a id="tabG" href="#/g" class="tab">ä¿è­·è€…</a>
      <a id="tabT" href="#/t" class="tab">è¬›å¸«</a>
      <span id="dbg" class="badge hidden">DEBUG</span>
    </nav>
  </div>
</header>

<!-- Landing -->
<div id="landingCover" class="landing-cover">
  <div class="landing-panel">
    <h1>éŸ³èª­SURASURA</h1>
    <div class="note">ãƒ­ãƒ¼ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆç”Ÿå¾’/ä¿è­·è€…/ã‚¹ã‚­ãƒƒãƒ—ã¯ãã®ã¾ã¾ã€è¬›å¸«ã¯ID/PWï¼‰</div>
    <div class="tilegrid" style="margin:12px 0 12px">
      <a id="goS" href="#/s" class="tile stu">ğŸ§’ <b>ç”Ÿå¾’ã§å…¥ã‚‹</b></a>
      <a id="goG" href="#/g" class="tile guard">ğŸ‘ª <b>ä¿è­·è€…ã§å…¥ã‚‹</b></a>
      <a id="goSkip" href="#/s" class="tile skip">ğŸ‘€ <b>ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè¦‹å­¦ï¼‰</b></a>
      <a id="goT" href="#/t" class="tile teach">ğŸ‘©â€ğŸ« <b>è¬›å¸«ãƒ­ã‚°ã‚¤ãƒ³</b></a>
    </div>
    <div class="row"><label><input type="checkbox" id="rememberRole"> æ¬¡å›ã‹ã‚‰ã“ã®ãƒ­ãƒ¼ãƒ«ã§é–‹ãï¼ˆã“ã®ç«¯æœ«ï¼‰</label></div>
    <hr>
    <h3 style="margin:8px 0 6px">è¬›å¸«ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆé–‹ç™ºä¸­ï¼‰</h3>
    <div class="row">
      <input id="loginId" placeholder="ID">
      <input id="loginPw" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button id="loginBtn" class="primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div class="note">ID/PWï¼š<span class="badge">surasura / surasura</span></div>
    </div>
  </div>
</div>

<main class="wrapper">
  <!-- Student -->
  <section id="viewS" class="card hidden">
    <h2>ç”Ÿå¾’ï½œéŸ³èª­</h2>
    <div class="row">
      <span>ã“ã®ç«¯æœ«ã®ç”Ÿå¾’ï¼š</span><span id="studentBadge" class="badge">æœªè¨­å®š</span>
      <button id="setStudentBtn">ç”Ÿå¾’ã‚’è¨­å®š</button>
      <div style="margin-left:auto;display:flex;gap:6px">
        <button class="fontBtn" data-size="24">Aâˆ’</button>
        <button class="fontBtn" data-size="28">A</button>
        <button class="fontBtn" data-size="34">Aï¼‹</button>
        <button class="fontBtn" data-size="42">Aï¼‹ï¼‹</button>
      </div>
    </div>
    <div class="row">
      <label>èª­ã‚€ãƒ†ã‚­ã‚¹ãƒˆï¼š</label>
      <select id="textSelectS" style="min-width:260px"></select>
      <input id="textNo" placeholder="ç•ªå·ã§æŒ‡å®šï¼ˆä»»æ„ï¼‰" inputmode="numeric">
      <button id="loadPassageBtn">èª­è¾¼</button>
    </div>
    <div id="readingText"></div>
    <textarea id="passageS" class="hidden"></textarea>
    <div class="row">
      <label>èªè­˜ï¼ˆè‡ªå‹•ï¼‰</label>
      <textarea id="asrText" placeholder="ã“ã“ã«èªè­˜çµæœãŒå…¥ã‚Šã¾ã™"></textarea>
    </div>
    <canvas id="viz" width="700" height="120" style="width:100%;height:120px;border:1px solid #233047;border-radius:12px;background:#0b1322"></canvas>
    <div class="tool-fixed">
      <button id="startBtn" class="btn-start">â–¶ éŒ²éŸ³é–‹å§‹</button>
      <button id="pauseBtn" class="btn-pause" disabled>â¸ ä¸€æ™‚åœæ­¢</button>
      <button id="stopBtn" class="btn-stop" disabled>â–  åœæ­¢</button>
    </div>
    <div class="row">
      <button id="analyzeBtn" class="good">æ¡ç‚¹</button>
      <span id="scoreStatus" class="badge">æœªæ¡ç‚¹</span>
      <button id="saveBtn" disabled>ä¿å­˜</button>
      <button id="dlAudioBtn" class="warn" disabled>éŸ³å£°DL</button>
      <span style="margin-left:auto" class="badge">é€£ç¶š <b id="streak">0</b> æ—¥ï½œç´¯è¨ˆ <b id="totalDays">0</b> æ—¥</span>
    </div>
    <div id="scoreBox">
      <ul class="row" style="gap:8px">
        <li class="badge">é€Ÿåº¦ <b id="speedCpm">-</b> æ–‡å­—/åˆ†</li>
        <li class="badge">CER <b id="cer">-</b></li>
        <li class="badge">F0ãƒ¬ãƒ³ã‚¸ <b id="f0range">-</b> Hz</li>
        <li class="badge">æŠ‘æš <b id="prosodyScore">-</b>/20</li>
        <li class="badge">ç·åˆ <b id="overall">-</b>/100</li>
      </ul>
      <div style="margin-top:8px"><b>èª¤èª­ï¼ˆæ¨å®šï¼‰</b>ï¼š<span id="missKanjis"></span></div>
    </div>
    <hr>
    <div><b>æ­£è§£ï¼š</b> <span id="refHl"></span></div>
    <div><b>èª­ä¸Šï¼š</b> <span id="hypHl"></span></div>
  </section>

  <!-- Teacher -->
  <section id="viewT" class="card hidden">
    <h2>è¬›å¸«ï½œç®¡ç†ãƒ»æ—¥æ¬¡ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ</h2>
    <div class="card" style="margin:-4px 0 10px 0">
      <h3>1) ç”Ÿå¾’ç®¡ç†</h3>
      <div class="row">
        <input id="studentName" placeholder="æ°å">
        <input id="studentSchool" placeholder="å­¦æ ¡å">
        <select id="studentGrade">
          <option>å°1</option><option>å°2</option><option>å°3</option>
          <option selected>å°4</option><option>å°5</option><option>å°6</option>
        </select>
        <button id="addStudentBtn" class="primary">ç”Ÿå¾’è¿½åŠ </button>
      </div>
      <div class="row">
        <input id="searchSchool" placeholder="å­¦æ ¡ã§çµã‚Šè¾¼ã¿ï¼ˆä»»æ„ï¼‰">
        <select id="searchGrade">
          <option value="">å­¦å¹´ã§çµã‚Šè¾¼ã¿ï¼ˆä»»æ„ï¼‰</option>
          <option value="1">å°1</option><option value="2">å°2</option><option value="3">å°3</option>
          <option value="4">å°4</option><option value="5">å°5</option><option value="6">å°6</option>
        </select>
        <button id="searchStudentsBtn">æ¤œç´¢</button>
      </div>
      <div class="row">
        <label>ç”Ÿå¾’ä¸€è¦§ï¼š</label>
        <select id="studentList"></select>
        <button id="delStudentBtn" class="danger">å‰Šé™¤</button>
      </div>
    </div>

    <div class="card" style="margin:-4px 0 10px 0">
      <h3>2) ãƒ†ã‚­ã‚¹ãƒˆç•ªå·ç®¡ç†ï¼ˆæœ¬æ–‡ã²ã‚‚ä»˜ã‘ï¼‰</h3>
      <div class="row">
        <input id="textNoT" placeholder="ç•ªå·ï¼ˆä¾‹ï¼š1001ï¼‰" style="width:140px">
        <input id="titleT" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰" style="flex:1">
        <button id="savePassageBtn" class="primary">ä¿å­˜/æ›´æ–°</button>
      </div>
      <textarea id="passageT" placeholder="æœ¬æ–‡ï¼ˆãµã‚ŠãŒãªå¯ï¼‰"></textarea>
      <div class="row">
        <button id="listPassagesBtn">ç•ªå·ä¸€è¦§ã‚’è¡¨ç¤º</button>
        <button id="delPassageBtn" class="danger">å‰Šé™¤</button>
      </div>
      <table class="table" id="passageTable"><thead><tr><th>ç•ªå·</th><th>ã‚¿ã‚¤ãƒˆãƒ«</th><th>å…ˆé ­ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="card" style="margin:-4px 0 10px 0">
      <h3>3) ä»Šæ—¥ã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ</h3>
      <div class="row"><button id="refreshTodayBtn">æ›´æ–°</button>
        <button id="exportCsvBtn" class="warn">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      </div>
      <table class="table" id="todayTable"><thead><tr>
        <th>æ™‚åˆ»</th><th>ç”Ÿå¾’</th><th>å­¦å¹´</th><th>ç•ªå·</th><th>é€Ÿåº¦</th><th>CER</th><th>F0</th><th>ç·åˆ</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- Guardian -->
  <section id="viewG" class="card hidden">
    <h2>ä¿è­·è€…ï½œæœ¬æ—¥ã®çµæœ</h2>
    <div id="guardianBind" class="note">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ï¼ˆmamaï¼‰ã¾ãŸã¯æ‹›å¾…ãƒªãƒ³ã‚¯ã§é–²è¦§ã§ãã¾ã™ã€‚</div>
    <div class="row">
      <span>ãŠå­ã•ã¾ï¼š</span> <span id="gStudent" class="badge">æœªé€£æº</span>
      <button id="gInstallBtn">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã®æ‰‹é †</button>
    </div>
    <table class="table" id="gTable"><thead><tr>
      <th>æ—¥æ™‚</th><th>ç•ªå·</th><th>é€Ÿåº¦</th><th>CER</th><th>ç·åˆ</th>
    </tr></thead><tbody></tbody></table>
  </section>

  <section class="card">
    <h2>ãƒ­ã‚°</h2>
    <pre id="log" style="white-space:pre-wrap;max-height:160px;overflow:auto"></pre>
  </section>
</main>

<script>
/* ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
const qs=s=>document.querySelector(s), qsa=s=>Array.from(document.querySelectorAll(s));
const debug=new URLSearchParams(location.search).get('debug')==='1';
if(debug) qs('#dbg').classList.remove('hidden');
function log(...a){ if(!debug) return; const el=qs('#log'); el.textContent+=a.join(' ')+"\\n"; el.scrollTop=el.scrollHeight; }
window.onerror=(m,src,ln,col,err)=>{ try{log('ERROR:',m,src+':'+ln+':'+col,err&&err.stack?err.stack:'');}catch(_){}; return false; };
window.addEventListener('unhandledrejection',e=>{ try{log('PROMISE:',e.reason&&(e.reason.stack||e.reason));}catch(_){}; });

function z2(n){return String(n).padStart(2,'0')}
function ymd(d){return \`\${d.getFullYear()}-\${z2(d.getMonth()+1)}-\${z2(d.getDate())}\`}
function ymdhm(t){const d=new Date(t);return \`\${d.getFullYear()}-\${z2(d.getMonth()+1)}-\${z2(d.getDate())} \${z2(d.getHours())}:\${z2(d.getMinutes())}\`}
function normalizeText(t){ if(!t) return ''; t=t.replace(/<rt>.*?<\\/rt>/g,'').replace(/<[^>]+>/g,''); t=t.replace(/[\\s\\u3000]/g,'').replace(/[ã€ï¼Œ]/g,'ã€').replace(/[ã€‚ï¼]/g,'ã€‚'); t=t.replace(/[ã€Œã€ã€ã€ï¼ˆï¼‰()ï¼»ï¼½\\[\\]ã€ˆã€‰<>ãƒ»â€¦ ,\\.\\-\\?\\!ï¼?]/g,''); t=t.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0)); return t; }
function isKanji(ch){ return /[\\u4E00-\\u9FFF\\u3400-\\u4DBF]/.test(ch); }
function academicYear(d){ const y=d.getFullYear(); const boundary=new Date(y,3,2); return (d>=boundary)?y:y-1; }
function parseGrade(label){ const m=String(label||'').match(/å°\\s*([1-6])/); return m?Number(m[1]):1; }
function currentGradeNum(st){ const base=st.grade_base||parseGrade(st.grade||'å°1'); const baseAy=st.grade_base_ay||academicYear(new Date(st.created_at||Date.now())); const delta=academicYear(new Date())-baseAy; return Math.min(6,Math.max(1,base+delta)); }
function currentGradeLabel(st){ return \`å°\${currentGradeNum(st)}\`; }
function fmt2(x){ return (Math.round(Number(x)*100)/100).toFixed(2); }

/* ========= IndexedDB ========= */
const DB='oral_roles_v0213_lite'; // ã‚¹ã‚­ãƒ¼ãƒã¯åŒä¸€ã€è¡çªå›é¿ã®ãŸã‚åå‰ã ã‘æ›´æ–°
let db;
function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(DB,1);
    r.onupgradeneeded=e=>{
      const db=e.target.result, tx=e.target.transaction;
      let s; if(!db.objectStoreNames.contains('students')) s=db.createObjectStore('students',{keyPath:'id',autoIncrement:true}); else s=tx.objectStore('students');
      if(!s.indexNames.contains('name')) s.createIndex('name','name');
      if(!s.indexNames.contains('school')) s.createIndex('school','school');
      if(!s.indexNames.contains('grade_base')) s.createIndex('grade_base','grade_base');
      if(!s.indexNames.contains('grade_base_ay')) s.createIndex('grade_base_ay','grade_base_ay');

      let sess; if(!db.objectStoreNames.contains('sessions')) sess=db.createObjectStore('sessions',{keyPath:'id',autoIncrement:true}); else sess=tx.objectStore('sessions');
      if(!sess.indexNames.contains('student_id')) sess.createIndex('student_id','student_id');
      if(!sess.indexNames.contains('created_at')) sess.createIndex('created_at','created_at');

      if(!db.objectStoreNames.contains('passages')) db.createObjectStore('passages',{keyPath:'no'});
      if(!db.objectStoreNames.contains('invites')) db.createObjectStore('invites',{keyPath:'token'});

      let g; if(!db.objectStoreNames.contains('guardians')) g=db.createObjectStore('guardians',{keyPath:'id',autoIncrement:true}); else g=tx.objectStore('guardians');
      if(!g.indexNames.contains('student_id')) g.createIndex('student_id','student_id');
    };
    r.onsuccess=()=>{ db=r.result; res(); };
    r.onerror=()=>rej(r.error);
  });
}
function tx(name,mode='readonly'){ return db.transaction(name,mode).objectStore(name); }
const idb={
  addStudent:(obj)=>new Promise((res,rej)=>{ const s={...obj,created_at:obj.created_at||Date.now()}; const r=tx('students','readwrite').add(s); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }),
  delStudent:id=>new Promise((res,rej)=>{ const r=tx('students','readwrite').delete(id); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }),
  listStudents:()=>new Promise((res,rej)=>{ const out=[]; const c=tx('students').openCursor(); c.onsuccess=e=>{ const cur=e.target.result; if(cur){ out.push({...cur.value,id:cur.primaryKey}); cur.continue(); } else res(out); }; c.onerror=()=>rej(c.error); }),
  savePassage:(no,title,text)=>new Promise((res,rej)=>{ const r=tx('passages','readwrite').put({no:String(no),title,text}); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }),
  delPassage:no=>new Promise((res,rej)=>{ const r=tx('passages','readwrite').delete(String(no)); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }),
  getPassage:no=>new Promise((res,rej)=>{ const r=tx('passages').get(String(no)); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); }),
  listPassages:()=>new Promise((res,rej)=>{ const out=[]; const c=tx('passages').openCursor(); c.onsuccess=e=>{ const cur=e.target.result; if(cur){ out.push(cur.value); cur.continue(); } else res(out); }; c.onerror=()=>rej(c.error); }),
  saveSession:s=>new Promise((res,rej)=>{ const r=tx('sessions','readwrite').add(s); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }),
  listSessions:(studentId=null,startMs=null,endMs=null)=>new Promise((res,rej)=>{
    const out=[]; const store=tx('sessions');
    const req=studentId?store.index('student_id').openCursor(IDBKeyRange.only(studentId)):store.openCursor();
    req.onsuccess=e=>{ const cur=e.target.result; if(cur){ const v={...cur.value,id:cur.primaryKey}; if((startMs==null||v.created_at>=startMs)&&(endMs==null||v.created_at<endMs)) out.push(v); cur.continue(); } else res(out.sort((a,b)=>b.created_at-a.created_at)); };
    req.onerror=()=>rej(req.error);
  })
};

/* ========= èªè¨¼/ãƒŠãƒ“ ========= */
function teacherAuthed(){ try{return localStorage.getItem('teacher_auth')==='1'}catch(_){return false} }
function guardianAuthed(){ try{return localStorage.getItem('guardian_auth')==='1'}catch(_){return false} }
function setAutoPref(on){ try{localStorage.setItem('autojump',on?'1':'0')}catch(_){} }
function enterRole(role){
  try{ const chk=qs('#rememberRole'); if(chk) setAutoPref(chk.checked); localStorage.setItem('last_role',role);}catch(_){}
  if(role==='s') location.hash='#/s';
  else if(role==='g') location.hash='#/g';
  else if(role==='t') location.hash='#/t';
  setActiveTab();
}
function loginTeacher(){
  const id=(qs('#loginId')?.value||'').trim();
  const pw=(qs('#loginPw')?.value||'').trim();
  if(id==='surasura'&&pw==='surasura'){ try{localStorage.setItem('teacher_auth','1')}catch(_){} enterRole('t'); }
  else alert('IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
}
async function guardGuardian(){
  if(guardianAuthed()) return true;
  const pw=prompt('ä¿è­·è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆé–‹ç™ºä¸­ï¼šmamaï¼‰');
  if(pw==='mama'){ try{localStorage.setItem('guardian_auth','1')}catch(_){} return true; }
  alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'); return false;
}
function updateTopNav(){ const t=qs('#tabT'); t.style.display=teacherAuthed()?'inline-block':'none'; qs('#tabG').style.display='inline-block'; }
function setActiveTab(){
  let raw=location.hash||'#/start'; let h=raw.split('?')[0];
  if(h.startsWith('#/t')&&!teacherAuthed()){ h='#/start'; if(location.hash!=='#/start'){location.hash='#/start';} }
  if(h.startsWith('#/g')&&!guardianAuthed()){
    (async()=>{ const ok=await guardGuardian(); if(ok){location.hash='#/g'; setActiveTab();} else {location.hash='#/start'; setActiveTab();} })();
    h='#/start';
  }
  qsa('a.tab').forEach(a=>a.classList.remove('active'));
  if(h.startsWith('#/s')) qs('#tabS').classList.add('active');
  else if(h.startsWith('#/t')) qs('#tabT').classList.add('active');
  else if(h.startsWith('#/g')) qs('#tabG').classList.add('active');

  const onLanding=(h==="#/start"||h==="#/");
  const cover=qs('#landingCover'); if(cover){ cover.classList.toggle('hidden',!onLanding); }
  document.body.classList.toggle('landing-active',onLanding);
  qs('#viewS').classList.toggle('hidden',!h.startsWith('#/s'));
  qs('#viewT').classList.toggle('hidden',!h.startsWith('#/t'));
  qs('#viewG').classList.toggle('hidden',!h.startsWith('#/g'));
  updateTopNav();
  if(h.startsWith('#/t')) refreshTeacher();
  if(h.startsWith('#/g')) initGuardianToday();
}
window.addEventListener('hashchange',setActiveTab);
setTimeout(()=>{
  // ä¸Šéƒ¨ã‚¿ãƒ–
  qsa('a.tab').forEach(a=>a.addEventListener('click',e=>{
    const href=a.getAttribute('href'); if(!href) return;
    e.preventDefault();
    if(href==="#/t"&&!teacherAuthed()){ location.hash='#/start'; setActiveTab(); qs('#loginId')?.focus(); return; }
    if(href==="#/g"&&!guardianAuthed()){ guardGuardian().then(ok=>{ if(ok){location.hash='#/g'; setActiveTab();} }); return; }
    location.hash=href; setActiveTab();
  }));
  // ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã®ã‚¿ã‚¤ãƒ«
  qs('#goS')?.addEventListener('click',e=>{ e.preventDefault(); enterRole('s'); });
  qs('#goSkip')?.addEventListener('click',e=>{ e.preventDefault(); enterRole('s'); });
  qs('#goG')?.addEventListener('click',async e=>{ e.preventDefault(); const ok=await guardGuardian(); if(ok) enterRole('g'); });
  qs('#goT')?.addEventListener('click',e=>{ e.preventDefault(); if(teacherAuthed()) enterRole('t'); else { location.hash='#/start'; setActiveTab(); qs('#loginId')?.focus(); } });

  qs('#loginBtn')?.addEventListener('click',loginTeacher);
  qs('#loginId')?.addEventListener('keydown',e=>{ if(e.key==='Enter') loginTeacher(); });
  qs('#loginPw')?.addEventListener('keydown',e=>{ if(e.key==='Enter') loginTeacher(); });
},0);

/* ========= éŒ²éŸ³ / ASR ========= */
let mediaStream,audioCtx,analyser,procNode,recorder,recChunks=[],isPaused=false,rafId=null;
let asr=null; // â† v0.2.13 ã§è¿½åŠ ï¼ˆåœæ­¢æ¼ã‚Œå¯¾ç­–ï¼‰

function startViz(){
  const canvas=qs('#viz'); if(!canvas||!analyser) return;
  const ctx=canvas.getContext('2d'); const {width,height}=canvas; const data=new Uint8Array(analyser.fftSize);
  function draw(){
    analyser.getByteTimeDomainData(data);
    ctx.clearRect(0,0,width,height);
    ctx.beginPath(); const mid=height/2;
    for(let x=0;x<width;x++){
      const i=Math.floor(x/data.length*data.length);
      const y=(data[i]-128)/128* (height*0.4);
      if(x===0) ctx.moveTo(x,mid+y); else ctx.lineTo(x,mid+y);
    }
    ctx.strokeStyle='#cfe6ff'; ctx.lineWidth=2; ctx.stroke();
    rafId=requestAnimationFrame(draw);
  }
  cancelAnimationFrame(rafId); rafId=requestAnimationFrame(draw);
}
function stopViz(){ if(rafId){ cancelAnimationFrame(rafId); rafId=null; const c=qs('#viz'); c&&c.getContext('2d').clearRect(0,0,c.width,c.height); }

async function startRec(){
  mediaStream=await navigator.mediaDevices.getUserMedia({audio:true});
  recorder=new MediaRecorder(mediaStream);
  recChunks=[]; recorder.ondataavailable=e=>{ if(e.data.size>0) recChunks.push(e.data); };
  recorder.start();
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const src=audioCtx.createMediaStreamSource(mediaStream);
  analyser=audioCtx.createAnalyser(); analyser.fftSize=1024;
  procNode=audioCtx.createScriptProcessor(1024,1,1); procNode.onaudioprocess=e=>{};
  src.connect(analyser); analyser.connect(procNode); procNode.connect(audioCtx.destination);
  qs('#readingText').classList.add('reading-anim');
  startViz();
}
async function pauseRec(){ if(!recorder) return; if('pause' in recorder && recorder.state==='recording'){ recorder.pause(); isPaused=true; } }
async function resumeRec(){ if(!recorder) return; if('resume' in recorder && recorder.state==='paused'){ recorder.resume(); isPaused=false; } }
async function stopRec(){
  try{ recorder && recorder.state!=='inactive' && recorder.stop(); }catch(_){} 
  try{ mediaStream && mediaStream.getTracks().forEach(t=>t.stop()); }catch(_){}
  try{ procNode && procNode.disconnect(); analyser && analyser.disconnect(); }catch(_){}
  if(audioCtx){ try{ await audioCtx.close(); }catch(_){} }
  qs('#readingText').classList.remove('reading-anim');
  stopViz();
  // v0.2.13: ASR ã‚’ç¢ºå®Ÿã«åœæ­¢
  try{ if(asr){ asr.onresult=null; asr.onend=null; asr.onerror=null; asr.stop(); } }catch(_){}
  asr=null;
}
function startASR(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web Speech APIã«æœªå¯¾å¿œã§ã™ã€‚Chromeã‚’ãŠè©¦ã—ãã ã•ã„ã€‚'); return false; }
  asr=new SR(); asr.lang='ja-JP'; asr.interimResults=true; asr.continuous=true;
  let asrText=''; const area=qs('#asrText');
  asr.onresult=e=>{
    let tmp=''; for(let i=e.resultIndex;i<e.results.length;i++){ const r=e.results[i]; if(r.isFinal) asrText+=r[0].transcript; else tmp+=r[0].transcript; }
    area.value=asrText+tmp;
  };
  asr.onend=()=>{ log('ASR end'); }; // å¿…è¦ãªã‚‰å†é–‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 
  asr.onerror=ev=>{ log('ASR error',ev&&ev.error); };
  asr.start(); return true;
}

/* ========= æ¡ç‚¹ï¼ˆç°¡æ˜“ï¼‰ ========= */
function analyzeLite(refRaw,hypRaw){
  const ref=normalizeText(refRaw), hyp=normalizeText(hypRaw);
  const cpm=Math.round(hyp.length/Math.max(1e-6,1));
  const cer=ref.length?Math.max(0,Math.min(1,(ref.length-hyp.length)/ref.length)):0;
  const overall=Math.max(0,Math.min(100,Math.round(85-cer*40+Math.min(20,Math.floor(cpm/30)))));
  return {cpm,cer,f0range:0,prosodyScore:0,overall,missList:[],refHtml:refRaw,hypHtml:hypRaw};
}

/* ========= ç”Ÿå¾’ UI ========= */
let currentStudentId=Number(localStorage.getItem('student_id')||0);
function updateStudentBadge(){
  if(!currentStudentId){ qs('#studentBadge').textContent='æœªè¨­å®š'; return; }
  idb.listStudents().then(l=>{ const st=l.find(x=>x.id===currentStudentId); qs('#studentBadge').textContent=st? \`\${st.name}ï¼ˆ\${currentGradeLabel(st)}ï¼‰\`:'æœªè¨­å®š'; });
}
async function chooseStudent(){
  const list=await idb.listStudents();
  if(!list.length){ alert('ã¾ãšè¬›å¸«ç”»é¢ï¼ˆ#/tï¼‰ã§ç”Ÿå¾’ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚'); return; }
  const name=prompt('ç”Ÿå¾’åã‚’é¸ã‚“ã§å…¥åŠ›ã—ã¦ãã ã•ã„\\n'+list.map(s=>\`ãƒ»\${s.name}ï¼ˆ\${currentGradeLabel(s)}ï½œ\${s.school||'å­¦æ ¡'}ï¼‰\`).join('\\n'));
  const found=list.find(s=>s.name===name);
  if(!found){ alert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); return; }
  currentStudentId=found.id; localStorage.setItem('student_id',String(currentStudentId));
  updateStudentBadge(); refreshStudentTexts(); updateStreakUI();
}
async function loadPassageByNo(no){
  const p=await idb.getPassage(no);
  if(!p){ alert('ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ç•ªå·ã§ã™'); return; }
  qs('#readingText').textContent=p.text||''; qs('#passageS').value=p.text||''; qs('#readingText').scrollTop=0;
}
async function refreshStudentTexts(){
  const sel=qs('#textSelectS'); if(!sel) return; sel.innerHTML='';
  const passages=await idb.listPassages();
  const rows=await idb.listSessions(currentStudentId);
  const countByNo={}; rows.forEach(r=>{ const k=r.text_no; countByNo[k]=(countByNo[k]||0)+1; });
  passages.sort((a,b)=>String(a.no).localeCompare(String(b.no))).forEach(p=>{
    const n=countByNo[p.no]||0; const o=document.createElement('option');
    o.value=p.no; o.textContent=\`\${p.no} \${p.title||''}ï¼ˆ\${n}å›ï¼‰\`; sel.appendChild(o);
  });
  // æœ€åˆã®1ä»¶ã‚’æœ¬æ–‡ã«åæ˜ ï¼ˆç©ºãªã‚‰ä½•ã‚‚ã—ãªã„ï¼‰
  if(passages.length){ loadPassageByNo(passages[0].no); sel.value=passages[0].no; }
}

/* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºï¼šä¿å­˜ï¼†å¾©å…ƒ */
function applyFontSize(px){ qs('#readingText').style.fontSize=px+'px'; try{ localStorage.setItem('reading_font_px',String(px)); }catch(_){} }
(function restoreFont(){ const px=Number(localStorage.getItem('reading_font_px')||28); applyFontSize(px); })();

qs('#setStudentBtn').onclick=chooseStudent;
qs('#loadPassageBtn').onclick=()=>{
  const typed=qs('#textNo').value.trim();
  const sel=qs('#textSelectS').value;
  const no=typed||sel;
  if(no) loadPassageByNo(no);
};
qs('#textSelectS').addEventListener('change',e=>{ const no=e.target.value; if(no) loadPassageByNo(no); });
qsa('.fontBtn').forEach(b=> b.addEventListener('click',()=>{ const sz=Number(b.dataset.size||28); applyFontSize(sz); }));

qs('#startBtn').onclick= async ()=>{
  qs('#startBtn').disabled=true; qs('#stopBtn').disabled=false; qs('#pauseBtn').disabled=false; qs('#saveBtn').disabled=true; qs('#dlAudioBtn').disabled=true; isPaused=false;
  await startRec(); const ok=startASR();
  if(!ok){ qs('#startBtn').disabled=false; qs('#stopBtn').disabled=true; qs('#pauseBtn').disabled=true; }
};
qs('#pauseBtn').onclick= async ()=>{ if(!recorder) return;
  if(isPaused){ await resumeRec(); qs('#pauseBtn').textContent='â¸ ä¸€æ™‚åœæ­¢'; }
  else { await pauseRec(); qs('#pauseBtn').textContent='â–¶ å†é–‹'; }
};
qs('#stopBtn').onclick= async ()=>{
  await stopRec();
  qs('#startBtn').disabled=false; qs('#stopBtn').disabled=true; qs('#pauseBtn').disabled=true; qs('#pauseBtn').textContent='â¸ ä¸€æ™‚åœæ­¢'; qs('#dlAudioBtn').disabled=false;
};
qs('#dlAudioBtn').onclick=()=>{
  if(!recChunks.length) return;
  const blob=new Blob(recChunks,{type:'audio/webm'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=\`reading_\${Date.now()}.webm\`; a.click();
};
function speakResult(overall){ try{ const s=new SpeechSynthesisUtterance(\`æ¡ç‚¹çµæœã€ç·åˆ \${overall} ç‚¹ã€‚ãŠã¤ã‹ã‚Œã•ã¾ã€‚\`); s.lang='ja-JP'; speechSynthesis.speak(s);}catch(_){} }

async function updateStreakUI(){
  if(!currentStudentId){ qs('#streak').textContent='0'; qs('#totalDays').textContent='0'; return; }
  const rows=await idb.listSessions(currentStudentId);
  const days=[...new Set(rows.map(r=>ymd(new Date(r.created_at))))].sort();
  const total=days.length; let streak=0;
  if(total){
    let cur=new Date(); cur.setHours(0,0,0,0); let i=days.length-1;
    const todayStr=ymd(cur);
    if(days[i]!==todayStr){ cur.setDate(cur.getDate()-1); }
    while(i>=0){ const dstr=ymd(cur); if(days[i]===dstr){ streak++; i--; cur.setDate(cur.getDate()-1); } else break; }
  }
  qs('#streak').textContent=String(streak); qs('#totalDays').textContent=String(total);
}

qs('#analyzeBtn').onclick=()=>{
  const refRaw=qs('#passageS').value.trim()||qs('#readingText').textContent.trim();
  const hypRaw=qs('#asrText').value.trim();
  if(!refRaw||!hypRaw){ alert('æœ¬æ–‡ã¨èªè­˜çµæœãŒå¿…è¦ã§ã™'); return; }
  const r=analyzeLite(refRaw,hypRaw);
  qs('#speedCpm').textContent=r.cpm; qs('#cer').textContent=fmt2(r.cer); qs('#f0range').textContent=r.f0range; qs('#prosodyScore').textContent=r.prosodyScore; qs('#overall').textContent=r.overall;
  qs('#missKanjis').textContent=r.missList.join('ã€€'); qs('#refHl').innerHTML=r.refHtml; qs('#hypHl').innerHTML=r.hypHtml;
  qs('#scoreStatus').textContent='æ¡ç‚¹æ¸ˆã¿'; qs('#saveBtn').disabled=false;
  qs('#saveBtn').onclick= async ()=>{
    if(!currentStudentId){ alert('ã“ã®ç«¯æœ«ã®ç”Ÿå¾’ã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }
    const no=(qs('#textSelectS').value||qs('#textNo').value||'').trim();
    const row={created_at:Date.now(),student_id:currentStudentId,text_no:no,cpm:r.cpm,cer:r.cer,f0range:r.f0range,prosodyScore:r.prosodyScore,overall:r.overall,miss_kanji:{}};
    await idb.saveSession(row); await updateStreakUI(); qs('#scoreStatus').textContent='ä¿å­˜æ¸ˆã¿'; speakResult(r.overall); alert('ä¿å­˜ã—ã¾ã—ãŸ');
  };
};

/* ========= è¬›å¸« ========= */
async function refreshTeacher(){
  const list=await idb.listStudents();
  const schoolF=(qs('#searchSchool')?.value.trim())||'';
  const gradeF=(qs('#searchGrade')?.value)||'';
  const filtered=list.filter(s=>{
    const okSchool=!schoolF||(String(s.school||'').includes(schoolF));
    const okGrade=!gradeF||(currentGradeNum(s)===Number(gradeF));
    return okSchool&&okGrade;
  });
  const sel=qs('#studentList'); if(sel){ sel.innerHTML=''; filtered.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=\`\${s.name}ï¼ˆ\${currentGradeLabel(s)}ï½œ\${s.school||'å­¦æ ¡æœªç™»éŒ²'}ï¼‰\`; sel.appendChild(o); }); }
  await listPassages(); await refreshToday();
}
qs('#addStudentBtn').onclick= async ()=>{
  const name=qs('#studentName').value.trim(); const school=qs('#studentSchool').value.trim(); const gradeLabel=qs('#studentGrade').value;
  if(!name) return alert('æ°åã‚’å…¥ã‚Œã¦ãã ã•ã„');
  const s={name,school,grade:gradeLabel,grade_base:parseGrade(gradeLabel),grade_base_ay:academicYear(new Date())};
  await idb.addStudent(s);
  qs('#studentName').value=''; qs('#studentSchool').value='';
  await refreshTeacher();
};
qs('#delStudentBtn').onclick= async ()=>{
  const id=Number(qs('#studentList').value||0); if(!id) return;
  if(!confirm('ã“ã®ç”Ÿå¾’ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼ˆå±¥æ­´ã¯æ®‹ã‚Šã¾ã™ï¼‰ï¼Ÿ')) return;
  await idb.delStudent(id); await refreshTeacher();
};

/* ãƒ†ã‚­ã‚¹ãƒˆç®¡ç† */
async function listPassages(){
  const t=qs('#passageTable tbody'); if(!t) return; t.innerHTML='';
  const rows=await idb.listPassages();
  rows.sort((a,b)=>String(a.no).localeCompare(String(b.no)));
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=\`<td>\${r.no}</td><td>\${r.title||''}</td><td>\${(r.text||'').slice(0,22)}â€¦</td>\`;
    tr.onclick=()=>{ qs('#textNoT').value=r.no; qs('#titleT').value=r.title||''; qs('#passageT').value=r.text||''; };
    t.appendChild(tr);
  });
}
qs('#savePassageBtn').onclick= async ()=>{
  const no=qs('#textNoT').value.trim(); const title=qs('#titleT').value.trim(); const text=qs('#passageT').value.trim();
  if(!no||!text) return alert('ç•ªå·ã¨æœ¬æ–‡ã‚’å…¥ã‚Œã¦ãã ã•ã„');
  await idb.savePassage(no,title,text); await listPassages(); alert('ä¿å­˜/æ›´æ–°ã—ã¾ã—ãŸ');
};
qs('#delPassageBtn').onclick= async ()=>{
  const no=qs('#textNoT').value.trim(); if(!no) return;
  if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  await idb.delPassage(no); await listPassages();
};
qs('#listPassagesBtn').onclick=listPassages;

/* ä»Šæ—¥ã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ */
async function refreshToday(){
  const today=new Date(); today.setHours(0,0,0,0);
  const start=today.getTime(), end=start+86400000;
  const rows=await idb.listSessions(null,start,end);
  const t=qs('#todayTable tbody'); if(t) t.innerHTML='';
  const students=await idb.listStudents(); const sMap=new Map(students.map(s=>[s.id,s]));
  rows.forEach(r=>{
    const st=sMap.get(r.student_id)||{name:'?',grade:'?',school:''};
    if(t){ const tr=document.createElement('tr'); tr.innerHTML=\`<td>\${ymdhm(r.created_at)}</td><td>\${st.name}</td><td>\${currentGradeLabel(st)}</td><td>\${r.text_no||''}</td><td>\${r.cpm}</td><td>\${fmt2(r.cer)}</td><td>\${r.f0range}</td><td>\${r.overall}</td>\`; t.appendChild(tr); }
  });
}
qs('#refreshTodayBtn').onclick=refreshToday;
qs('#searchStudentsBtn')?.addEventListener('click',refreshTeacher);
qs('#searchSchool')?.addEventListener('keydown',e=>{ if(e.key==='Enter') refreshTeacher(); });
qs('#searchGrade')?.addEventListener('change',refreshTeacher);
qs('#exportCsvBtn').onclick= async ()=>{
  const rows=await idb.listSessions();
  const hdr=['datetime','student','grade_current','text_no','cpm','cer','f0range','prosody','overall'];
  const students=await idb.listStudents(); const sMap=new Map(students.map(s=>[s.id,s]));
  const lines=[hdr.join(',')];
  rows.forEach(r=>{
    const st=sMap.get(r.student_id)||{name:'?',grade:'?',school:''};
    const vals=[new Date(r.created_at).toISOString(),st.name,currentGradeLabel(st),r.text_no||'',r.cpm,fmt2(r.cer),r.f0range,r.prosodyScore||0,r.overall].map(v=>\`"\${String(v).replace(/"/g,'""')}"\`);
    lines.push(vals.join(','));
  });
  const blob=new Blob([lines.join('\\n')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='oral_reading_history.csv'; a.click();
};

/* ========= ä¿è­·è€…ï¼ˆå½“æ—¥åˆ†ã®ã¿ï¼‰ ========= */
async function initGuardianToday(){
  const sid=Number(localStorage.getItem('guardian_student_id')||0);
  if(!sid){ qs('#gStudent').textContent='æœªé€£æº'; return; }
  const st=(await idb.listStudents()).find(s=>s.id===sid);
  qs('#gStudent').textContent=st? \`\${st.name}ï¼ˆ\${currentGradeLabel(st)}ï¼‰\`:'æœªé€£æº';
  const today=new Date(); today.setHours(0,0,0,0);
  const rows=await idb.listSessions(sid,today.getTime(),today.getTime()+86400000);
  const tb=qs('#gTable tbody'); if(tb) tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=\`<td>\${ymdhm(r.created_at)}</td><td>\${r.text_no||''}</td><td>\${r.cpm}</td><td>\${fmt2(r.cer)}</td><td>\${r.overall}</td>\`;
    tb?.appendChild(tr);
  });
}
qs('#gInstallBtn').onclick=()=>{ alert('ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ï¼š\\n1) å³ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆâ‹® / å…±æœ‰ï¼‰â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€\\n2) è¿½åŠ å¾Œã¯ãã®ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰èµ·å‹•ã§ãã¾ã™ã€‚'); };

/* ========= ã‚µãƒ³ãƒ—ãƒ«æ³¨å…¥ ========= */
async function injectSamplesIfEmpty(){
  const ps=await idb.listPassages(); if(ps.length>=5) return;
  for(let g=1; g<=6; g++){
    for(let i=1;i<=10;i++){
      const no=\`G\${g}-\${String(i).padStart(3,'0')}\`;
      const title=\`å°\${g}ã‚µãƒ³ãƒ—ãƒ«\${String(i).padStart(2,'0')}\`;
      const text=\`å°\${g}ã®ã‚µãƒ³ãƒ—ãƒ«æ–‡ç«  \${String(i).padStart(2,'0')}ã€‚ãã‚‡ã†ã¯è‰¯ã„å¤©æ°—ã§ã™ã€‚å·ã®ãªãŒã‚ŒãŒãã‚‰ãã‚‰å…‰ã‚Šã¾ã™ã€‚\`;
      await idb.savePassage(no,title,text);
    }
  }
}

/* ========= åˆæœŸåŒ– ========= */
function autoJump(){
  try{
    const auto=localStorage.getItem('autojump')==='1';
    const last=localStorage.getItem('last_role');
    const atStart=(!location.hash||location.hash==='#'||location.hash==='#/'||location.hash==='#/start');
    if(auto && atStart && last){
      if(last==='t'){ if(teacherAuthed()) location.hash='#/t'; }
      else if(last==='s') location.hash='#/s';
      else if(last==='g'){ if(guardianAuthed()) location.hash='#/g'; }
    }
  }catch(_){}
}
async function init(){
  await openDB(); await injectSamplesIfEmpty();
  autoJump(); setActiveTab(); updateStreakUI(); refreshStudentTexts();
}
window.addEventListener('load',init);
</script>
</body>
</html>
