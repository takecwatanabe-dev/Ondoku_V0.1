<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>音読SURASURA（Roles） V0.2.6</title>
<meta name="theme-color" content="#0b1020">
<style>
:root{
  --bg:#0b1020;--panel:#111827;--ink:#e6f1ff;--muted:#8aa0bf;--accent:#4f8cff;
  --ok:#20e3c2;--warn:#ffce3a;--bad:#ff6b6b;--shadow:0 10px 24px rgba(0,0,0,.45);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
header{position:sticky;top:0;background:linear-gradient(180deg,rgba(0,0,0,.5),transparent),var(--panel);
  padding:10px 14px;box-shadow:var(--shadow);z-index:50}
h1{margin:0;font-size:18px}
small.ver{color:#8aa0bf;margin-left:8px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#1e293b;color:#cfe6ff;border:1px solid #2a3a56;font-size:12px}
.note{color:#9bb2d1;font-size:12px}
.wrapper{display:grid;grid-template-columns:1fr;gap:16px;padding:14px;max-width:980px;margin:0 auto}
.card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;box-shadow:var(--shadow);padding:14px}
.card h2{margin:4px 0 10px 0;font-size:16px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
input,select,button,textarea{background:#0c1322;color:var(--ink);border:1px solid #233047;border-radius:12px;padding:10px 12px;font-size:14px}
textarea{width:100%;min-height:120px;line-height:1.6}
button{cursor:pointer}
button.primary{background:var(--accent);border-color:#2f63d1}
button.good{background:var(--ok);border-color:#17b79b;color:#06231d}
button.warn{background:var(--warn);border-color:#b69200;color:#261e00}
button.danger{background:#d44;border-color:#b22}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #24324a;padding:8px;font-size:13px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.hidden{display:none!important}
.kbd{border:1px solid #334155;background:#0b1322;padding:2px 6px;border-radius:6px;font-size:12px}
hr{border:none;border-top:1px solid #203049;margin:12px 0}
.flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto}
.tabnav{display:flex;gap:8px}
a.tab{color:#cfe6ff;text-decoration:none;border:1px solid #2a3a56;border-radius:999px;padding:6px 10px}
a.tab.active{background:#24324a}
.hl-miss{background:#3a1020;color:#ffd7de;border-bottom:1px dashed #ff6b6b}
canvas{background:#0b1322;border:1px solid #233047;border-radius:12px}
@media (max-width:640px){
  header h1{font-size:16px}
  button{padding:12px 14px}
  textarea{min-height:96px}
  #viz{height:80px}
}
</style>
</head>
<body>
<header>
  <div class="flex">
    <div>
      <h1>音読SURASURA（ロール切替）<small class="ver">V0.2.6</small></h1>
      <div class="note">#/start=入口｜#/s=生徒｜#/t=講師｜#/g=保護者（招待リンク）｜?debug=1でログ</div>
    </div>
    <nav class="tabnav right">
      <a id="tabS" href="#/s" class="tab">生徒</a>
      <a id="tabT" href="#/t" class="tab">講師</a>
      <a id="tabG" href="#/g" class="tab">保護者</a>
      <span id="dbg" class="badge hidden">DEBUG</span>
    </nav>
  </div>
</header>

<main class="wrapper">
  <!-- オープニング（ランディング／ロール選択） -->
  <section id="viewStart" class="card">
    <h2>ようこそ — 音読SURASURA</h2>
    <div class="note">ロールを選んでください（開発中：<b>生徒/保護者/スキップはボタンだけ</b>、<b>講師は簡易ログイン</b>）</div>
    <div class="row">
      <button id="goS" class="primary" style="font-size:18px;padding:14px 18px">生徒で入る</button>
      <button id="goG" class="primary" style="font-size:18px;padding:14px 18px">保護者で入る</button>
      <button id="goSkip" style="font-size:18px;padding:14px 18px">スキップ（見学）</button>
    </div>
    <div class="row"><label><input type="checkbox" id="rememberRole"> 次回からこのロールで開く（この端末）</label></div>
    <hr>
    <h3>講師ログイン（開発中）</h3>
    <div class="row">
      <input id="loginId" placeholder="ID">
      <input id="loginPw" type="password" placeholder="パスワード">
      <button id="loginBtn" class="primary">ログイン</button>
    </div>
    <div class="note">テスト用 ID / パスワード：<span class="kbd">surasura / surasura</span></div>
  </section>
  
  <!-- 生徒 -->
  <section id="viewS" class="card hidden">
    <h2>生徒｜音読</h2>
    <div class="row">
      <span>この端末の生徒：</span>
      <span id="studentBadge" class="badge">未設定</span>
      <button id="setStudentBtn">生徒を設定</button>
    </div>
    <div class="row">
      <input id="textNo" placeholder="テキスト番号（例：1001）" inputmode="numeric" style="flex:1">
      <button id="loadPassageBtn">読込</button>
    </div>
    <textarea id="passageS"></textarea>
    <div class="row">
      <button id="startBtn" class="primary">録音開始</button>
      <button id="stopBtn" class="danger" disabled>停止</button>
      <span id="recStatus" class="badge">準備OK</span>
    </div>
    <div class="row">
      <label>認識（自動）</label>
      <textarea id="asrText" class="mono" placeholder="ここに認識結果が入ります"></textarea>
    </div>
    <canvas id="viz" width="600" height="120" style="width:100%;height:120px"></canvas>
    <div class="row">
      <button id="analyzeBtn" class="good">採点</button>
      <span id="scoreStatus" class="badge">未採点</span>
      <button id="saveBtn" disabled>保存</button>
      <button id="dlAudioBtn" class="warn" disabled>音声DL</button>
    </div>
    <div id="scoreBox">
      <ul class="flex">
        <li class="badge">速度 <b id="speedCpm">-</b> 文字/分</li>
        <li class="badge">CER <b id="cer">-</b></li>
        <li class="badge">F0レンジ <b id="f0range">-</b> Hz</li>
        <li class="badge">抑揚 <b id="prosodyScore">-</b>/20</li>
        <li class="badge">総合 <b id="overall">-</b>/100</li>
      </ul>
      <div style="margin-top:8px">
        <b>誤読（推定）</b>：<span id="missKanjis" class="mono"></span>
      </div>
    </div>
    <hr>
    <div><b>正解：</b> <span id="refHl"></span></div>
    <div><b>読上：</b> <span id="hypHl"></span></div>
  </section>

  <!-- 講師 -->
  <section id="viewT" class="card hidden">
    <h2>講師｜管理・日次ダイジェスト</h2>

    <div class="card" style="margin:-4px 0 10px 0">
      <h3>1) 生徒管理</h3>
      <div class="row">
        <input id="studentName" placeholder="氏名">
        <input id="studentSchool" placeholder="学校名">
        <select id="studentGrade">
          <option>小1</option><option>小2</option><option>小3</option>
          <option selected>小4</option><option>小5</option><option>小6</option>
        </select>
        <button id="addStudentBtn" class="primary">生徒追加</button>
      </div>
      <div class="row">
        <input id="searchSchool" placeholder="学校で絞り込み（任意）">
        <select id="searchGrade">
          <option value="">学年で絞り込み（任意）</option>
          <option value="1">小1</option><option value="2">小2</option><option value="3">小3</option>
          <option value="4">小4</option><option value="5">小5</option><option value="6">小6</option>
        </select>
        <button id="searchStudentsBtn">検索</button>
      </div>
      <div class="row">
        <label>生徒一覧：</label>
        <select id="studentList"></select>
        <button id="delStudentBtn" class="danger">削除</button>
      </div>
    </div>

    <div class="card" style="margin:-4px 0 10px 0">
      <h3>2) テキスト番号管理（本文ひも付け）</h3>
      <div class="row">
        <input id="textNoT" placeholder="番号（例：1001）" style="width:140px">
        <input id="titleT" placeholder="タイトル（任意）" style="flex:1">
        <button id="savePassageBtn" class="primary">保存/更新</button>
      </div>
      <textarea id="passageT" placeholder="本文（ふりがな可）"></textarea>
      <div class="row">
        <button id="listPassagesBtn">番号一覧を表示</button>
        <button id="delPassageBtn" class="danger">削除</button>
      </div>
      <table class="table" id="passageTable"><thead><tr><th>番号</th><th>タイトル</th><th>先頭プレビュー</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="card" style="margin:-4px 0 10px 0">
      <h3>3) 保護者招待（マジックリンク作成 → メールに貼付）</h3>
      <div class="row">
        <label>対象生徒：</label>
        <select id="guardianStudent"></select>
        <input id="guardianMail" type="email" placeholder="保護者メール（任意）">
        <button id="genInviteBtn" class="primary">招待リンク作成</button>
      </div>
      <div class="row">
        <input id="inviteLink" placeholder="ここにリンクが表示されます" style="flex:1">
        <button id="copyInviteBtn">コピー</button>
        <a id="mailtoBtn" class="badge" href="#" target="_blank">メール作成</a>
      </div>
      <div class="note">※ 本MVPでは自動送信なし。作成したリンクをメールで送ってください。</div>
    </div>

    <div class="card" style="margin:-4px 0 10px 0">
      <h3>4) 今日のダイジェスト</h3>
      <div class="row"><button id="refreshTodayBtn">更新</button>
        <button id="exportCsvBtn" class="warn">CSVエクスポート</button>
      </div>
      <table class="table" id="todayTable"><thead><tr>
        <th>時刻</th><th>生徒</th><th>学年</th><th>番号</th><th>速度</th><th>CER</th><th>F0</th><th>総合</th>
      </tr></thead><tbody></tbody></table>
      <h4>誤読漢字ランキング（本日）</h4>
      <div id="kanjiRankToday" class="mono"></div>
    </div>
  </section>

  <!-- 保護者 -->
  <section id="viewG" class="card hidden">
    <h2>保護者｜本日の結果</h2>
    <div id="guardianBind" class="note">招待リンクからアクセスすると、お子さまと連携されます。</div>
    <div class="row">
      <span>お子さま：</span> <span id="gStudent" class="badge">未連携</span>
      <button id="gInstallBtn">ホーム画面に追加の手順</button>
    </div>
    <table class="table" id="gTable"><thead><tr>
      <th>日時</th><th>番号</th><th>速度</th><th>CER</th><th>総合</th>
    </tr></thead><tbody></tbody></table>
    <div class="note">※ 音声は既定で保存しません（保護者同意時のみ保存ONにできます）。</div>
  </section>

  <section class="card">
    <h2>ログ</h2>
    <pre id="log" class="mono" style="white-space:pre-wrap;max-height:160px;overflow:auto"></pre>
  </section>
</main>

<script>
/* ======= 便利関数 ======= */
const qs=s=>document.querySelector(s), qsa=s=>Array.from(document.querySelectorAll(s));
const debug = new URLSearchParams(location.search).get('debug')==='1';
if(debug) qs('#dbg').classList.remove('hidden');
function log(...a){ if(debug){ const el=qs('#log'); el.textContent+=a.join(' ') + "\n"; el.scrollTop=el.scrollHeight; } }
// runtime errors to [ログ]
window.onerror = (m,src,ln,col,err)=>{ try{log('ERROR:', m, src+':'+ln+':'+col, err&&err.stack?err.stack:'');}catch(_){}; return false; };
window.addEventListener('unhandledrejection', e=>{ try{log('PROMISE REJECTION:', e.reason && (e.reason.stack||e.reason));}catch(_){}; });
function z2(n){ return String(n).padStart(2,'0'); }
function ymdhm(t){ const d=new Date(t); return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())} ${z2(d.getHours())}:${z2(d.getMinutes())}`; }
function normalizeText(t){
  if(!t) return '';
  t = t.replace(/<rt>.*?<\/rt>/g,'').replace(/<[^>]+>/g,''); // ふりがな等を除去
  t = t.replace(/[\s\u3000]/g,'').replace(/[、，]/g,'、').replace(/[。．]/g,'。');
  t = t.replace(/[「」『』（）()［］\[\]〈〉<>・… ,\.\-\?\!！?]/g,'');
  t = t.replace(/[Ａ-Ｚａ-ｚ０-９]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0));
  return t;
}
function isKanji(ch){ return /[\u4E00-\u9FFF\u3400-\u4DBF]/.test(ch); }

// === 学年繰り上がりヘルパ ===
function academicYear(d){ const y=d.getFullYear(); const boundary=new Date(y,3,2); return (d>=boundary)? y : y-1; }
function parseGrade(label){ const m=String(label||'').match(/小\s*([1-6])/); return m?Number(m[1]):1; }
function currentGradeNum(st){ const base = st.grade_base || parseGrade(st.grade||'小1'); const baseAy = st.grade_base_ay || academicYear(new Date(st.created_at||Date.now())); const delta = academicYear(new Date()) - baseAy; return Math.min(6, Math.max(1, base + delta)); }
function currentGradeLabel(st){ return `小${currentGradeNum(st)}`; }

/* ======= IndexedDB ======= */
const DB='oral_roles_v02';
let db;
function openDB(){
  return new Promise((res,rej)=>{
    const r = indexedDB.open(DB,1);
    r.onupgradeneeded = e=>{
      const db=e.target.result;
      const tx=e.target.transaction;
      // students
      let s;
      if(!db.objectStoreNames.contains('students')){
        s=db.createObjectStore('students',{keyPath:'id',autoIncrement:true});
      }else{
        s=tx.objectStore('students');
      }
      if(!s.indexNames.contains('name')) s.createIndex('name','name',{unique:false});
      if(!s.indexNames.contains('school')) s.createIndex('school','school',{unique:false});
      if(!s.indexNames.contains('grade_base')) s.createIndex('grade_base','grade_base',{unique:false});
      if(!s.indexNames.contains('grade_base_ay')) s.createIndex('grade_base_ay','grade_base_ay',{unique:false});

      // sessions
      let sess;
      if(!db.objectStoreNames.contains('sessions')){
        sess=db.createObjectStore('sessions',{keyPath:'id',autoIncrement:true});
      }else{ sess=tx.objectStore('sessions'); }
      if(!sess.indexNames.contains('student_id')) sess.createIndex('student_id','student_id',{unique:false});
      if(!sess.indexNames.contains('created_at')) sess.createIndex('created_at','created_at',{unique:false});

      // passages
      if(!db.objectStoreNames.contains('passages')){ db.createObjectStore('passages',{keyPath:'no'}); }
      // invites
      if(!db.objectStoreNames.contains('invites')){ db.createObjectStore('invites',{keyPath:'token'}); }
      // guardians
      let g;
      if(!db.objectStoreNames.contains('guardians')){
        g=db.createObjectStore('guardians',{keyPath:'id',autoIncrement:true});
      }else{ g=tx.objectStore('guardians'); }
      if(!g.indexNames.contains('student_id')) g.createIndex('student_id','student_id',{unique:false});
    };
    r.onsuccess=()=>{ db=r.result; res(); };
    r.onerror=()=>rej(r.error);
  });
}
function tx(name,mode='readonly'){ return db.transaction(name,mode).objectStore(name); }
const idb = {
  addStudent:(obj)=>new Promise((res,rej)=>{ const s={...obj,created_at: obj.created_at||Date.now()}; const r=tx('students','readwrite').add(s); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }),
  delStudent:id=>new Promise((res,rej)=>{ const r=tx('students','readwrite').delete(id); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }),
  listStudents:()=>new Promise((res,rej)=>{ const out=[]; const c=tx('students').openCursor(); c.onsuccess=e=>{ const cur=e.target.result; if(cur){ out.push({...cur.value,id:cur.primaryKey}); cur.continue(); } else res(out);}; c.onerror=()=>rej(c.error); }),
  savePassage:(no,title,text)=>new Promise((res,rej)=>{ const r=tx('passages','readwrite').put({no:String(no),title,text}); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }),
  delPassage:no=>new Promise((res,rej)=>{ const r=tx('passages','readwrite').delete(String(no)); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }),
  getPassage:no=>new Promise((res,rej)=>{ const r=tx('passages').get(String(no)); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); }),
  listPassages:()=>new Promise((res,rej)=>{ const out=[]; const c=tx('passages').openCursor(); c.onsuccess=e=>{ const cur=e.target.result; if(cur){ out.push(cur.value); cur.continue(); } else res(out);}; c.onerror=()=>rej(c.error); }),
  saveSession:s=>new Promise((res,rej)=>{ const r=tx('sessions','readwrite').add(s); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }),
  listSessions:(studentId=null,startMs=null,endMs=null)=>new Promise((res,rej)=>{
    const out=[]; const store=tx('sessions');
    const req = studentId ? store.index('student_id').openCursor(IDBKeyRange.only(studentId)) : store.openCursor();
    req.onsuccess=e=>{ const cur=e.target.result; if(cur){
      const v={...cur.value,id:cur.primaryKey};
      if((startMs==null||v.created_at>=startMs)&&(endMs==null||v.created_at<endMs)) out.push(v);
      cur.continue();
    } else res(out.sort((a,b)=>b.created_at-a.created_at)); };
    req.onerror=()=>rej(req.error);
  }),
  saveInvite:(token,student_id,mail)=>new Promise((res,rej)=>{ const r=tx('invites','readwrite').put({token,student_id,mail,created_at:Date.now(),used:false}); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }),
  getInvite:token=>new Promise((res,rej)=>{ const r=tx('invites').get(token); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); }),
  useInvite:token=>new Promise((res,rej)=>{ const s=tx('invites','readwrite').get(token); s.onsuccess=()=>{ const inv=s.result; if(!inv) return res(false);
      inv.used=true; tx('invites','readwrite').put(inv).onsuccess=()=>res(true); }; s.onerror=()=>rej(s.error); }),
  addGuardian:(student_id)=>new Promise((res,rej)=>{ const r=tx('guardians','readwrite').add({student_id,created_at:Date.now()}); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }),
  listGuardiansByStudent:(student_id)=>new Promise((res,rej)=>{ const out=[]; const c=tx('guardians').index('student_id').openCursor(IDBKeyRange.only(student_id)); c.onsuccess=e=>{ const cur=e.target.result; if(cur){ out.push({...cur.value,id:cur.primaryKey}); cur.continue(); } else res(out); }; c.onerror=()=>rej(c.error); }),
};

/* ======= ロール選択／ログイン ======= */
function setAutoPref(on){ try{ localStorage.setItem('autojump', on?'1':'0'); }catch(_){} }
function enterRole(role){
  try{ if(qs('#rememberRole')) setAutoPref(qs('#rememberRole').checked); localStorage.setItem('last_role', role); }catch(_){ }
  if(role==='s') location.hash='#/s';
  else if(role==='g') location.hash='#/g';
  else if(role==='t') location.hash='#/t';
  setActiveTab();
}
function teacherAuthed(){ try{ return localStorage.getItem('teacher_auth')==='1'; }catch(_){ return false; } }
function loginTeacher(){
  const id=(qs('#loginId')&&qs('#loginId').value||'').trim();
  const pw=(qs('#loginPw')&&qs('#loginPw').value||'').trim();
  if(id==='surasura' && pw==='surasura'){
    try{ localStorage.setItem('teacher_auth','1'); }catch(_){}
    enterRole('t');
  }else{
    alert('IDまたはパスワードが違います');
  }
}

/* ======= ルーティング（#/start, #/s, #/t, #/g） ======= */
function setActiveTab(){
  let raw = location.hash || '#/start';
  let h = raw.split('?')[0];
  // teacher guard
  if(h.startsWith('#/t') && !teacherAuthed()){
    h = '#/start';
    if(location.hash!=='#/start'){ location.hash = '#/start'; }
  }
  qsa('a.tab').forEach(a=>a.classList.remove('active'));
  if(h.startsWith('#/s')) qs('#tabS').classList.add('active');
  else if(h.startsWith('#/t')) qs('#tabT').classList.add('active');
  else if(h.startsWith('#/g')) qs('#tabG').classList.add('active');

  qs('#viewStart').classList.toggle('hidden', !(h==='#/start' || h==='#/'));
  qs('#viewS').classList.toggle('hidden', !h.startsWith('#/s'));
  qs('#viewT').classList.toggle('hidden', !h.startsWith('#/t'));
  qs('#viewG').classList.toggle('hidden', !h.startsWith('#/g'));

  if(h.startsWith('#/t')) refreshTeacher();
  if(h.startsWith('#/g')) initGuardianFromToken();
}
window.addEventListener('hashchange', setActiveTab);
// ensure click-to-nav works even if default anchor behavior is blocked
setTimeout(()=>{
  qsa('a.tab').forEach(a=>{
    a.addEventListener('click', e=>{ const href=a.getAttribute('href'); if(!href) return; e.preventDefault();
      if(href==='#/t' && !teacherAuthed()){ location.hash='#/start'; setActiveTab(); qs('#loginId')&&qs('#loginId').focus(); return; }
      location.hash=href; setActiveTab();
    });
  });
  if(qs('#goS')) qs('#goS').onclick=()=>enterRole('s');
  if(qs('#goG')) qs('#goG').onclick=()=>enterRole('g');
  if(qs('#goSkip')) qs('#goSkip').onclick=()=>enterRole('s');
  if(qs('#goT')) qs('#goT').onclick=()=>{ if(teacherAuthed()) enterRole('t'); else { location.hash='#/start'; setActiveTab(); qs('#loginId')&&qs('#loginId').focus(); } };
  if(qs('#loginBtn')) qs('#loginBtn').onclick=loginTeacher;
  if(qs('#loginId')) qs('#loginId').addEventListener('keydown',e=>{ if(e.key==='Enter') loginTeacher(); });
  if(qs('#loginPw')) qs('#loginPw').addEventListener('keydown',e=>{ if(e.key==='Enter') loginTeacher(); });
},0);

/* ======= 生徒：録音/ASR/採点 ======= */
let mediaStream, audioCtx, analyser, procNode, recorder, recChunks=[], asr, asrActive=false;
let voicedMs=0, f0Stats={vals:[],min:9999,max:0};

const viz = qs('#viz'); const vctx = viz.getContext('2d');

function drawViz(timeData, f0){
  const w=viz.width,h=viz.height;
  vctx.fillStyle='#0b1322'; vctx.fillRect(0,0,w,h);
  vctx.strokeStyle='#88aaff'; vctx.beginPath();
  for(let i=0;i<timeData.length;i++){
    const x=i/timeData.length*w; const y=(timeData[i]/128)*0.45*h + 0.25*h;
    if(i===0) vctx.moveTo(x,y); else vctx.lineTo(x,y);
  }
  vctx.stroke();
  vctx.fillStyle='#20e3c2';
  f0.slice(-60).forEach((hz,idx)=>{
    if(hz>0){ const x = w - (60-idx)*(w/60); const y = 0.75*h + (1 - Math.min(hz,500)/500)*0.25*h;
      vctx.beginPath(); vctx.arc(x,y,2,0,Math.PI*2); vctx.fill();
    }
  });
}
function autocorrF0(buf, sr){
  const minLag=Math.floor(sr/500), maxLag=Math.floor(sr/70);
  let bestLag=0,best=0;
  for(let lag=minLag; lag<=maxLag; lag++){
    let c=0; for(let i=0;i<buf.length-lag;i++) c+=buf[i]*buf[i+lag];
    if(c>best){ best=c; bestLag=lag; }
  }
  if(bestLag===0||best<1e-3) return 0;
  return sr/bestLag;
}

async function startRec(){
  mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
  recorder = new MediaRecorder(mediaStream);
  recChunks=[]; recorder.ondataavailable=e=>{ if(e.data.size>0) recChunks.push(e.data); };
  recorder.start();

  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const src = audioCtx.createMediaStreamSource(mediaStream);
  analyser = audioCtx.createAnalyser(); analyser.fftSize=1024;

  procNode = audioCtx.createScriptProcessor(1024,1,1);
  const timeBuf = new Uint8Array(analyser.fftSize); const f0Arr=f0Stats.vals=[]; f0Stats.min=9999; f0Stats.max=0;
  voicedMs=0;

  procNode.onaudioprocess = e=>{
    const ch = e.inputBuffer.getChannelData(0);
    let rms=0; for(let i=0;i<ch.length;i++) rms+=ch[i]*ch[i];
    rms=Math.sqrt(rms/ch.length);
    if(rms>0.01){
      voicedMs += (ch.length/audioCtx.sampleRate)*1000;
      const f0=autocorrF0(ch,audioCtx.sampleRate);
      if(f0>60&&f0<500){
        f0Arr.push(f0);
        if(f0<f0Stats.min) f0Stats.min=f0;
        if(f0>f0Stats.max) f0Stats.max=f0;
      }else f0Arr.push(0);
    }else f0Arr.push(0);
    analyser.getByteTimeDomainData(timeBuf);
    drawViz(timeBuf,f0Arr);
  };
  src.connect(analyser); analyser.connect(procNode); procNode.connect(audioCtx.destination);
  qs('#recStatus').textContent='録音中…';
}
async function stopRec(){
  recorder && recorder.state!=='inactive' && recorder.stop();
  mediaStream && mediaStream.getTracks().forEach(t=>t.stop());
  procNode && procNode.disconnect(); analyser && analyser.disconnect();
  audioCtx && audioCtx.close();
  qs('#recStatus').textContent='停止';
}

function startASR(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert('このブラウザはWeb Speech APIに未対応です。Chromeをお試しください。'); return false; }
  asr = new SR(); asr.lang='ja-JP'; asr.interimResults=true; asr.continuous=true;
  let asrText=''; const area=qs('#asrText');
  asr.onresult = e=>{
    let tmp=''; for(let i=e.resultIndex;i<e.results.length;i++){
      const r=e.results[i]; if(r.isFinal) asrText += r[0].transcript; else tmp += r[0].transcript;
    }
    area.value = asrText + tmp;
  };
  asr.onend=()=>{ asrActive=false; };
  asr.start(); asrActive=true; return true;
}

function levenshteinAlign(a,b){
  const n=a.length,m=b.length,dp=Array.from({length:n+1},()=>Array(m+1).fill(0));
  for(let i=0;i<=n;i++) dp[i][0]=i; for(let j=0;j<=m;j++) dp[0][j]=j;
  for(let i=1;i<=n;i++) for(let j=1;j<=m;j++){
    const cost=a[i-1]===b[j-1]?0:1;
    dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+cost);
  }
  let i=n,j=m,ops=[];
  while(i>0||j>0){
    if(i>0 && dp[i][j]===dp[i-1][j]+1){ ops.push({op:'del',ref:a[i-1],hyp:''}); i--; }
    else if(j>0 && dp[i][j]===dp[i][j-1]+1){ ops.push({op:'ins',ref:'',hyp:b[j-1]}); j--; }
    else { const op=(a[i-1]===b[j-1])?'eq':'sub'; ops.push({op,ref:a[i-1],hyp:b[j-1]}); i--; j--; }
  }
  ops.reverse(); return {dist:dp[n][m],ops};
}
function highlightAlign(ops){
  let refHtml='',hypHtml='';
  for(const o of ops){
    if(o.op==='eq'){ refHtml+=`<span>${o.ref}</span>`; hypHtml+=`<span>${o.hyp}</span>`; }
    else if(o.op==='sub'){ refHtml+=`<span class="hl-miss">${o.ref}</span>`; hypHtml+=`<span class="hl-miss">${o.hyp}</span>`; }
    else if(o.op==='del'){ refHtml+=`<span class="hl-miss">${o.ref}</span>`; hypHtml+=`<span>∅</span>`; }
    else if(o.op==='ins'){ refHtml+=`<span>∅</span>`; hypHtml+=`<span class="hl-miss">${o.hyp}</span>`; }
  }
  return {refHtml,hypHtml};
}
function arrMean(a){ if(!a.length) return 0; return a.reduce((x,y)=>x+y,0)/a.length; }
function arrSdPos(a){ const v=a.filter(x=>x>0); const m=arrMean(v); const s=arrMean(v.map(x=>(x-m)*(x-m))); return Math.sqrt(s||0); }

function analyzeAll(refRaw,hypRaw,voicedMsLocal,f0){
  const ref=normalizeText(refRaw), hyp=normalizeText(hypRaw);
  const {dist,ops}=levenshteinAlign(ref.split(''),hyp.split(''));
  const cer=(ref.length?dist/ref.length:1);
  const missKanji={};
  ops.forEach(o=>{ if((o.op==='sub'||o.op==='del') && isKanji(o.ref)) missKanji[o.ref]=(missKanji[o.ref]||0)+1; });
  const missList=Object.entries(missKanji).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${k}:${v}`);

  const minutes=Math.max(1e-6, voicedMsLocal/60000);
  const cpm=Math.round(hyp.length/minutes);

  const f0min=Math.round((f0.min===9999)?0:f0.min), f0max=Math.round(f0.max||0);
  const f0range=(f0max>0&&f0min>0)?(f0max-f0min):0, f0sd=Math.round(arrSdPos(f0.vals));
  let prosody=0;
  if(f0range>40) prosody+=10; else if(f0range>20) prosody+=6; else if(f0range>10) prosody+=3;
  if(f0sd>30) prosody+=10; else if(f0sd>15) prosody+=6; else if(f0sd>8) prosody+=3;
  prosody=Math.min(20,prosody);

  let acc=Math.max(0,40*(1-cer));
  let spd=0; if(cpm>=180&&cpm<=300) spd=20; else if(cpm<180) spd=Math.max(0,20*(cpm/180)); else spd=Math.max(0,20*(1-(cpm-300)/300));
  const overall=Math.round(acc+prosody+spd);
  const {refHtml,hypHtml}=highlightAlign(ops);

  return {cpm,cer:Number(cer.toFixed(3)),f0range,prosodyScore:prosody,overall,missKanji,missList,refHtml,hypHtml};
}

/* ======= 生徒UIロジック ======= */
let currentStudentId = Number(localStorage.getItem('student_id')||0);
function updateStudentBadge(){
  if(!currentStudentId) { qs('#studentBadge').textContent='未設定'; return; }
  idb.listStudents().then(l=>{
    const st=l.find(x=>x.id===currentStudentId);
    qs('#studentBadge').textContent = st ? `${st.name}（${currentGradeLabel(st)}）` : '未設定';
  });
}
async function chooseStudent(){
  const list=await idb.listStudents();
  if(!list.length){ alert('まず講師画面（#/t）で生徒を追加してください。'); return; }
  const name=prompt('生徒名を選んで入力してください\n' + list.map(s=>`・${s.name}（${currentGradeLabel(s)}）`).join('\n'));
  const found=list.find(s=>s.name===name);
  if(!found){ alert('見つかりませんでした'); return; }
  currentStudentId=found.id; localStorage.setItem('student_id',String(currentStudentId));
  updateStudentBadge();
}
async function loadPassageByNo(no, into){
  const p = await idb.getPassage(no);
  if(!p){ alert('登録されていない番号です'); return; }
  into.value = p.text||'';
  qs('#passageS')===into && (qs('#passageS').scrollTop=0);
}

// 生徒画面のイベント
qs('#setStudentBtn').onclick = chooseStudent;
qs('#loadPassageBtn').onclick = ()=>{ const no=qs('#textNo').value.trim(); if(no) loadPassageByNo(no,qs('#passageS')); };
qs('#startBtn').onclick = async ()=>{
  qs('#startBtn').disabled=true; qs('#stopBtn').disabled=false; qs('#saveBtn').disabled=true; qs('#dlAudioBtn').disabled=true;
  await startRec();
  const ok = startASR();
  if(!ok){ qs('#startBtn').disabled=false; qs('#stopBtn').disabled=true; }
};
qs('#stopBtn').onclick = async ()=>{
  await stopRec();
  qs('#startBtn').disabled=false; qs('#stopBtn').disabled=true; qs('#dlAudioBtn').disabled=false;
};
qs('#dlAudioBtn').onclick = ()=>{
  if(!recChunks.length) return;
  const blob=new Blob(recChunks,{type:'audio/webm'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`reading_${Date.now()}.webm`; a.click();
};
qs('#analyzeBtn').onclick = ()=>{
  const refRaw=qs('#passageS').value.trim(); const hypRaw=qs('#asrText').value.trim();
  if(!refRaw||!hypRaw){ alert('本文と認識結果が必要です'); return; }
  const r=analyzeAll(refRaw,hypRaw,voicedMs,f0Stats);
  qs('#speedCpm').textContent=r.cpm; qs('#cer').textContent=r.cer; qs('#f0range').textContent=r.f0range;
  qs('#prosodyScore').textContent=r.prosodyScore; qs('#overall').textContent=r.overall;
  qs('#missKanjis').textContent=r.missList.join('　'); qs('#refHl').innerHTML=r.refHtml; qs('#hypHl').innerHTML=r.hypHtml;
  qs('#scoreStatus').textContent='採点済み'; qs('#saveBtn').disabled=false;
  qs('#saveBtn').onclick = async ()=>{
    if(!currentStudentId){ alert('この端末の生徒を設定してください'); return; }
    const no = qs('#textNo').value.trim()||'';
    const row={
      created_at:Date.now(), student_id:currentStudentId, text_no:no,
      cpm:r.cpm, cer:r.cer, f0range:r.f0range, prosodyScore:r.prosodyScore, overall:r.overall,
      miss_kanji:r.missKanji
    };
    await idb.saveSession(row);
    qs('#scoreStatus').textContent='保存済み';
    alert('保存しました');
  };
};

/* ======= 講師UI ======= */
async function refreshTeacher(){
  const list=await idb.listStudents();
  const schoolF=(qs('#searchSchool')&&qs('#searchSchool').value.trim())||'';
  const gradeF=(qs('#searchGrade')&&qs('#searchGrade').value)||'';
  const filtered=list.filter(s=>{
    const okSchool = !schoolF || (String(s.school||'').includes(schoolF));
    const okGrade = !gradeF || (currentGradeNum(s)===Number(gradeF));
    return okSchool && okGrade;
  });
  // 生徒一覧
  const sel=qs('#studentList'); if(sel){ sel.innerHTML=''; filtered.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=`${s.name}（${currentGradeLabel(s)}｜${s.school||'学校未登録'}）`; sel.appendChild(o); }); }
  // 保護者招待用
  const gs=qs('#guardianStudent'); if(gs){ gs.innerHTML=''; filtered.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=`${s.name}（${currentGradeLabel(s)}｜${s.school||'学校未登録'}）`; gs.appendChild(o); }); }
  // 今日のダイジェスト
  await refreshToday();
  // 番号一覧
  await listPassages();
}
qs('#addStudentBtn').onclick = async ()=>{
  const name=qs('#studentName').value.trim();
  const school=qs('#studentSchool').value.trim();
  const gradeLabel=qs('#studentGrade').value;
  if(!name) return alert('氏名を入れてください');
  const s={
    name,
    school,
    grade: gradeLabel,
    grade_base: parseGrade(gradeLabel),
    grade_base_ay: academicYear(new Date()),
  };
  await idb.addStudent(s);
  qs('#studentName').value=''; qs('#studentSchool').value='';
  await refreshTeacher();
};
qs('#delStudentBtn').onclick = async ()=>{
  const id=Number(qs('#studentList').value||0); if(!id) return;
  if(!confirm('この生徒を削除しますか（履歴は残ります）？')) return;
  await idb.delStudent(id); await refreshTeacher();
};

/* passages */
async function listPassages(){
  const t=qs('#passageTable tbody'); if(!t) return; t.innerHTML='';
  const rows=await idb.listPassages();
  rows.sort((a,b)=>String(a.no).localeCompare(String(b.no)));
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.no}</td><td>${r.title||''}</td><td>${(r.text||'').slice(0,22)}…</td>`;
    tr.onclick=()=>{ qs('#textNoT').value=r.no; qs('#titleT').value=r.title||''; qs('#passageT').value=r.text||''; };
    t.appendChild(tr);
  });
}
qs('#savePassageBtn').onclick = async ()=>{
  const no=qs('#textNoT').value.trim(); const title=qs('#titleT').value.trim(); const text=qs('#passageT').value.trim();
  if(!no||!text) return alert('番号と本文を入れてください');
  await idb.savePassage(no,title,text); await listPassages(); alert('保存/更新しました');
};
qs('#delPassageBtn').onclick = async ()=>{
  const no=qs('#textNoT').value.trim(); if(!no) return;
  if(!confirm('削除しますか？')) return;
  await idb.delPassage(no); await listPassages();
};
qs('#listPassagesBtn').onclick = listPassages;

/* 今日の集計 */
async function refreshToday(){
  const today=new Date(); today.setHours(0,0,0,0);
  const start=today.getTime(), end=start+86400000;
  const rows=await idb.listSessions(null,start,end);
  const t=qs('#todayTable tbody'); if(t) t.innerHTML='';
  const students=await idb.listStudents(); const sMap=new Map(students.map(s=>[s.id,s]));
  const aggKanji={};
  rows.forEach(r=>{
    const st=sMap.get(r.student_id)||{name:'?',grade:'?',school:''};
    if(t){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${ymdhm(r.created_at)}</td><td>${st.name}</td><td>${currentGradeLabel(st)}</td><td>${r.text_no||''}</td>
        <td>${r.cpm}</td><td>${r.cer}</td><td>${r.f0range}</td><td>${r.overall}</td>`;
      t.appendChild(tr);
    }
    for(const k in (r.miss_kanji||{})){ aggKanji[k]=(aggKanji[k]||0)+r.miss_kanji[k]; }
  });
  const rank = Object.entries(aggKanji).sort((a,b)=>b[1]-a[1]).slice(0,20).map(([k,v])=>`${k}:${v}`);
  const kr=qs('#kanjiRankToday'); if(kr) kr.textContent = rank.join('　');
}
qs('#refreshTodayBtn').onclick = refreshToday;
if(qs('#searchStudentsBtn')) qs('#searchStudentsBtn').onclick = refreshTeacher;
if(qs('#searchSchool')) qs('#searchSchool').addEventListener('keydown',e=>{ if(e.key==='Enter') refreshTeacher(); });
if(qs('#searchGrade')) qs('#searchGrade').addEventListener('change',refreshTeacher);
qs('#exportCsvBtn').onclick = async ()=>{
  const rows=await idb.listSessions();
  const hdr=['datetime','student','grade_current','text_no','cpm','cer','f0range','prosody','overall','miss_kanji_json'];
  const students=await idb.listStudents(); const sMap=new Map(students.map(s=>[s.id,s]));
  const lines=[hdr.join(',')];
  rows.forEach(r=>{
    const st=sMap.get(r.student_id)||{name:'?',grade:'?',school:''};
    const miss=JSON.stringify(r.miss_kanji||{});
    const vals=[new Date(r.created_at).toISOString(),st.name,currentGradeLabel(st),r.text_no||'',r.cpm,r.cer,r.f0range,r.prosodyScore,r.overall,miss]
      .map(v=>`"${String(v).replace(/"/g,'""')}"`);
    lines.push(vals.join(','));
  });
  const blob=new Blob([lines.join('\n')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='oral_reading_history.csv'; a.click();
};

/* ======= 保護者招待 ======= */
function randToken(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
qs('#genInviteBtn').onclick = async ()=>{
  const student_id=Number(qs('#guardianStudent').value||0);
  if(!student_id) return alert('生徒を選択してください');
  const mail=(qs('#guardianMail').value||'').trim();
  const token=randToken();
  await idb.saveInvite(token,student_id,mail);
  const url = location.href.split('#')[0] + '#/g?token='+encodeURIComponent(token);
  qs('#inviteLink').value = url;
  navigator.clipboard && navigator.clipboard.writeText(url).catch(()=>{});
  const stList=await idb.listStudents(); const st=stList.find(s=>s.id===student_id);
  const subj='【招待】音読結果閲覧';
  const body=`${st?st.name:'お子さま'}の音読結果はこちら：\n${url}\n\n※端末のホーム画面に追加しておくと便利です。`;
  qs('#mailtoBtn').href = `mailto:${encodeURIComponent(mail)}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
  alert('招待リンクを作成しました。メールに貼り付けて送ってください。');
};
qs('#copyInviteBtn').onclick = ()=>{ const i=qs('#inviteLink'); i.select(); document.execCommand('copy'); };

/* ======= 保護者画面 ======= */
async function initGuardianFromToken(){
  const hash=location.hash||'';
  const q=hash.split('?')[1]||'';
  const params=new URLSearchParams(q);
  const token=params.get('token');
  if(token){
    const inv=await idb.getInvite(token);
    if(inv && !inv.used){
      await idb.addGuardian(inv.student_id);
      await idb.useInvite(token);
      qs('#guardianBind').textContent='この端末は招待によりお子さまと連携されました。';
      localStorage.setItem('guardian_student_id', String(inv.student_id));
    }
  }
  const sid=Number(localStorage.getItem('guardian_student_id')||0);
  if(!sid){ qs('#gStudent').textContent='未連携'; return; }
  const st=(await idb.listStudents()).find(s=>s.id===sid);
  qs('#gStudent').textContent = st? `${st.name}（${currentGradeLabel(st)}）` : '未連携';
  // 本日の結果
  const today=new Date(); today.setHours(0,0,0,0);
  const rows=await idb.listSessions(sid,today.getTime(),today.getTime()+86400000);
  const tb=qs('#gTable tbody'); if(tb) tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${ymdhm(r.created_at)}</td><td>${r.text_no||''}</td><td>${r.cpm}</td><td>${r.cer}</td><td>${r.overall}</td>`;
    if(tb) tb.appendChild(tr);
  });
}
qs('#gInstallBtn').onclick = ()=>{
  alert('ホーム画面に追加：\n1) 右上メニュー（⋮ / 共有）→「ホーム画面に追加」\n2) 追加後はそのアイコンから起動できます。');
};

/* ======= ルート初期化 ======= */
async function init(){
  try{ await openDB(); }
  catch(e){ log('IndexedDB error:', e); alert('初期化に失敗しました（ブラウザ設定で保存が制限？）。読み取り専用モードで続行します。'); }
  if('serviceWorker' in navigator){
    const ENABLE_SW = !location.hostname.endsWith('github.io'); // GitHub Pagesでは無効化（相性回避）
    if(ENABLE_SW){
      const sw=`
        self.addEventListener('install',e=>{ e.waitUntil(caches.open('oral-roles-v026').then(c=>c.addAll(['./']))); });
        self.addEventListener('fetch',e=>{ e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))); });
      `;
      const blob=new Blob([sw],{type:'text/javascript'});
      try{ await navigator.serviceWorker.register(URL.createObjectURL(blob)); log('SW registered'); }catch(e){ log('SW failed',e); }
    } else { log('ServiceWorker disabled on github.io'); }
  }
  // 自動遷移（任意：チェックON時のみ）
  try{
    const auto = localStorage.getItem('autojump')==='1';
    const last = localStorage.getItem('last_role');
    const atStart = (!location.hash || location.hash==='#' || location.hash==='#/' || location.hash==='#/start');
    if(auto && atStart && last){
      if(last==='t'){
        if(teacherAuthed()) { location.hash='#/t'; }
      } else if(last==='s') { location.hash='#/s'; }
      else if(last==='g') { location.hash='#/g'; }
    }
  }catch(_){}

  // デモ用パッセージを初期投入
  const ps=await idb.listPassages();
  if(!ps.length){
    await idb.savePassage('1001','春の川辺', '春の川辺を歩くと、冷たい風の中にも、少しずつあたたかさが感じられます。土手の草むらには、小さな花が顔を出し、川の流れはきらきらと光っています。ぼくは、遠くで鳴く鳥の声を聞きながら、ゆっくりと足もとを確かめて歩きました。');
    await idb.savePassage('1002','夏の入道雲', '夏の午後、空には大きな入道雲がむくむくと立ちのぼります。ひまわりの花は太陽を見上げ、遠くからは祭りの笛の音が聞こえてきます。わたしは汗をふきながらも、どこかうきうきした気持ちになりました。');
  }
  setActiveTab();
  selfTest();
}
// 早期にタブ切替（DB完了を待たない）
setActiveTab();
init().catch(e=>{ log('init failed:', e); });

/* ======= 簡易テスト（開発用） ======= */
function assert(cond,msg){ if(!cond){ console.error('[TEST] FAIL:',msg); log('[TEST] FAIL:',msg); } else { console.log('[TEST] OK:',msg); log('[TEST] OK:',msg); } }
function selfTest(){
  // smoke tests
  assert(!!qs('#goS') && !!qs('#goT') && !!qs('#goG'),'Landing buttons present');
  assert(typeof startRec==='function' && typeof startASR==='function','Recording functions exist');
  assert(typeof analyzeAll==='function','Analyze function exists');
  // routing basic
  location.hash='#/s'; setActiveTab();
  assert(!qs('#viewS').classList.contains('hidden'),'Student view shows');
  location.hash='#/t'; setActiveTab();
  assert(qs('#viewT').classList.contains('hidden'),'Teacher guarded when not logged in');
  const old=localStorage.getItem('teacher_auth');
  localStorage.setItem('teacher_auth','1');
  location.hash='#/t'; setActiveTab();
  assert(!qs('#viewT').classList.contains('hidden'),'Teacher view shows after auth');
  if(old==null) localStorage.removeItem('teacher_auth'); else localStorage.setItem('teacher_auth',old);
  // DB basic
  idb.listPassages().then(r=>assert(Array.isArray(r),'Passages can list'));
}
</script>
</body>
</html>
