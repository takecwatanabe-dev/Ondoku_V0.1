<!-- 2025-09-29 19:26 JST | Version: V0.2.13-lite -->
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#0b1020">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>音読SURASURA V0.2.13-lite</title>
<style>
:root{--bg:#0b1020;--panel:#111827;--ink:#e6f1ff;--accent:#4f8cff;--ok:#20e3c2;--warn:#ffce3a;--bad:#ff6b6b}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Hiragino Kaku Gothic ProN,Meiryo,sans-serif}
header{position:sticky;top:0;background:linear-gradient(180deg,rgba(0,0,0,.5),transparent),var(--panel);padding:10px 14px;z-index:50}
h1{margin:0;font-size:18px}
.note{color:#9bb2d1;font-size:12px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#1e293b;color:#cfe6ff;border:1px solid #2a3a56;font-size:12px}
.wrapper{display:grid;gap:16px;padding:14px;max-width:980px;margin:0 auto}
.card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
input,select,button,textarea{background:#0c1322;color:var(--ink);border:1px solid #233047;border-radius:12px;padding:10px 12px;font-size:14px}
a.tab{color:#cfe6ff;text-decoration:none;border:1px solid #2a3a56;border-radius:999px;padding:6px 10px}
a.tab.active{background:#24324a}
.hidden{display:none!important}

/* landing */
.landing-cover{position:fixed;inset:0;z-index:2147483647;display:grid;place-items:center;background:#0b1020}
.landing-cover::before{content:"";position:absolute;inset:0;background:radial-gradient(80% 60% at 50% 10%,rgba(79,140,255,.15),transparent),linear-gradient(180deg,rgba(0,0,0,.85),rgba(0,0,0,.92))}
.landing-panel{position:relative;width:min(860px,94vw);border-radius:24px;background:var(--panel);border:1px solid #22324a;padding:22px}
.tilegrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:640px){.tilegrid{grid-template-columns:1fr}}
.tile{display:flex;align-items:center;justify-content:center;border-radius:18px;padding:18px;font-size:18px;border:2px solid rgba(255,255,255,.1);box-shadow:0 8px 20px rgba(0,0,0,.4);cursor:pointer;text-decoration:none;color:inherit}
.tile.stu{background:#4f8cff}
.tile.guard{background:#20e3c2;color:#06231d}
.tile.skip{background:#ffce3a;color:#261e00}
.tile.teach{background:#ff6b6b}
body.landing-active header,body.landing-active main{visibility:hidden}

/* student */
.tool-fixed{position:sticky;bottom:0;z-index:20;background:linear-gradient(180deg,transparent,rgba(0,0,0,.4)),#0b1020;padding:8px;border-radius:14px;border:1px solid #1f2b44;display:flex;gap:8px;justify-content:space-between}
.tool-fixed button{font-size:18px;padding:14px 18px;border-radius:14px;flex:1}
.btn-start{background:#36d399}.btn-pause{background:#60a5fa}.btn-stop{background:#fb7185}
#readingText{min-height:180px;font-size:28px;line-height:1.9;border:1px solid #233047;border-radius:14px;padding:14px;background:#0c1322}
.reading-anim{animation:wiggle 1.2s ease-in-out infinite}
@keyframes wiggle{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
.hl-miss{background:#3a1020;color:#ffd7de;border-bottom:1px dashed #ff6b6b}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #24324a;padding:8px;font-size:13px}
</style>
</head>
<body>
<header>
  <div style="display:flex;gap:12px;align-items:center">
    <div>
      <h1>音読SURASURA <small class="badge">V0.2.13-lite</small></h1>
      <div class="note">#/start=入口｜#/s=生徒｜#/t=講師｜#/g=保護者（PW）｜?debug=1でログ</div>
    </div>
    <nav class="tabnav" style="margin-left:auto;display:flex;gap:8px">
      <a id="tabS" href="#/s" class="tab">生徒</a>
      <a id="tabG" href="#/g" class="tab">保護者</a>
      <a id="tabT" href="#/t" class="tab">講師</a>
      <span id="dbg" class="badge hidden">DEBUG</span>
    </nav>
  </div>
</header>

<!-- Landing -->
<div id="landingCover" class="landing-cover">
  <div class="landing-panel">
    <h1>音読SURASURA</h1>
    <div class="note">ロールを選んでください（生徒/保護者/スキップはそのまま、講師はID/PW）</div>
    <div class="tilegrid" style="margin:12px 0 12px">
      <a id="goS" href="#/s" class="tile stu">🧒 <b>生徒で入る</b></a>
      <a id="goG" href="#/g" class="tile guard">👪 <b>保護者で入る</b></a>
      <a id="goSkip" href="#/s" class="tile skip">👀 <b>スキップ（見学）</b></a>
      <a id="goT" href="#/t" class="tile teach">👩‍🏫 <b>講師ログイン</b></a>
    </div>
    <div class="row"><label><input type="checkbox" id="rememberRole"> 次回からこのロールで開く（この端末）</label></div>
    <hr>
    <h3 style="margin:8px 0 6px">講師ログイン（開発中）</h3>
    <div class="row">
      <input id="loginId" placeholder="ID">
      <input id="loginPw" type="password" placeholder="パスワード">
      <button id="loginBtn" class="primary">ログイン</button>
      <div class="note">ID/PW：<span class="badge">surasura / surasura</span></div>
    </div>
  </div>
</div>

<main class="wrapper">
  <!-- Student -->
  <section id="viewS" class="card hidden">
    <h2>生徒｜音読</h2>
    <div class="row">
      <span>この端末の生徒：</span><span id="studentBadge" class="badge">未設定</span>
      <button id="setStudentBtn">生徒を設定</button>
      <div style="margin-left:auto;display:flex;gap:6px">
        <button class="fontBtn" data-size="24">A−</button>
        <button class="fontBtn" data-size="28">A</button>
        <button class="fontBtn" data-size="34">A＋</button>
        <button class="fontBtn" data-size="42">A＋＋</button>
      </div>
    </div>
    <div class="row">
      <label>読むテキスト：</label>
      <select id="textSelectS" style="min-width:260px"></select>
      <input id="textNo" placeholder="番号で指定（任意）" inputmode="numeric">
      <button id="loadPassageBtn">読込</button>
    </div>
    <div id="readingText"></div>
    <textarea id="passageS" class="hidden"></textarea>
    <div class="row">
      <label>認識（自動）</label>
      <textarea id="asrText" placeholder="ここに認識結果が入ります"></textarea>
    </div>
    <canvas id="viz" width="700" height="120" style="width:100%;height:120px;border:1px solid #233047;border-radius:12px;background:#0b1322"></canvas>
    <div class="tool-fixed">
      <button id="startBtn" class="btn-start">▶ 録音開始</button>
      <button id="pauseBtn" class="btn-pause" disabled>⏸ 一時停止</button>
      <button id="stopBtn" class="btn-stop" disabled>■ 停止</button>
    </div>
    <div class="row">
      <button id="analyzeBtn" class="good">採点</button>
      <span id="scoreStatus" class="badge">未採点</span>
      <button id="saveBtn" disabled>保存</button>
      <button id="dlAudioBtn" class="warn" disabled>音声DL</button>
      <span style="margin-left:auto" class="badge">連続 <b id="streak">0</b> 日｜累計 <b id="totalDays">0</b> 日</span>
    </div>
    <div id="scoreBox">
      <ul class="row" style="gap:8px">
        <li class="badge">速度 <b id="speedCpm">-</b> 文字/分</li>
        <li class="badge">CER <b id="cer">-</b></li>
        <li class="badge">F0レンジ <b id="f0range">-</b> Hz</li>
        <li class="badge">抑揚 <b id="prosodyScore">-</b>/20</li>
        <li class="badge">総合 <b id="overall">-</b>/100</li>
      </ul>
      <div style="margin-top:8px"><b>誤読（推定）</b>：<span id="missKanjis"></span></div>
    </div>
    <hr>
    <div><b>正解：</b> <span id="refHl"></span></div>
    <div><b>読上：</b> <span id="hypHl"></span></div>
  </section>

  <!-- Teacher -->
  <section id="viewT" class="card hidden">
    <h2>講師｜管理・日次ダイジェスト</h2>
    <div class="card" style="margin:-4px 0 10px 0">
      <h3>1) 生徒管理</h3>
      <div class="row">
        <input id="studentName" placeholder="氏名">
        <input id="studentSchool" placeholder="学校名">
        <select id="studentGrade">
          <option>小1</option><option>小2</option><option>小3</option>
          <option selected>小4</option><option>小5</option><option>小6</option>
        </select>
        <button id="addStudentBtn" class="primary">生徒追加</button>
      </div>
      <div class="row">
        <input id="searchSchool" placeholder="学校で絞り込み（任意）">
        <select id="searchGrade">
          <option value="">学年で絞り込み（任意）</option>
          <option value="1">小1</option><option value="2">小2</option><option value="3">小3</option>
          <option value="4">小4</option><option value="5">小5</option><option value="6">小6</option>
        </select>
        <button id="searchStudentsBtn">検索</button>
      </div>
      <div class="row">
        <label>生徒一覧：</label>
        <select id="studentList"></select>
        <button id="delStudentBtn" class="danger">削除</button>
      </div>
    </div>

    <div class="card" style="margin:-4px 0 10px 0">
      <h3>2) テキスト番号管理（本文ひも付け）</h3>
      <div class="row">
        <input id="textNoT" placeholder="番号（例：1001）" style="width:140px">
        <input id="titleT" placeholder="タイトル（任意）" style="flex:1">
        <button id="savePassageBtn" class="primary">保存/更新</button>
      </div>
      <textarea id="passageT" placeholder="本文（ふりがな可）"></textarea>
      <div class="row">
        <button id="listPassagesBtn">番号一覧を表示</button>
        <button id="delPassageBtn" class="danger">削除</button>
      </div>
      <table class="table" id="passageTable"><thead><tr><th>番号</th><th>タイトル</th><th>先頭プレビュー</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="card" style="margin:-4px 0 10px 0">
      <h3>3) 今日のダイジェスト</h3>
      <div class="row"><button id="refreshTodayBtn">更新</button>
        <button id="exportCsvBtn" class="warn">CSVエクスポート</button>
      </div>
      <table class="table" id="todayTable"><thead><tr>
        <th>時刻</th><th>生徒</th><th>学年</th><th>番号</th><th>速度</th><th>CER</th><th>F0</th><th>総合</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- Guardian -->
  <section id="viewG" class="card hidden">
    <h2>保護者｜本日の結果</h2>
    <div id="guardianBind" class="note">パスワード認証（mama）または招待リンクで閲覧できます。</div>
    <div class="row">
      <span>お子さま：</span> <span id="gStudent" class="badge">未連携</span>
      <button id="gInstallBtn">ホーム画面に追加の手順</button>
    </div>
    <table class="table" id="gTable"><thead><tr>
      <th>日時</th><th>番号</th><th>速度</th><th>CER</th><th>総合</th>
    </tr></thead><tbody></tbody></table>
  </section>

  <section class="card">
    <h2>ログ</h2>
    <pre id="log" style="white-space:pre-wrap;max-height:160px;overflow:auto"></pre>
  </section>
</main>

<script>
/* ========= ユーティリティ ========= */
const qs=s=>document.querySelector(s), qsa=s=>Array.from(document.querySelectorAll(s));
const debug=new URLSearchParams(location.search).get('debug')==='1';
if(debug) qs('#dbg').classList.remove('hidden');
function log(...a){ if(!debug) return; const el=qs('#log'); el.textContent+=a.join(' ')+"\\n"; el.scrollTop=el.scrollHeight; }
window.onerror=(m,src,ln,col,err)=>{ try{log('ERROR:',m,src+':'+ln+':'+col,err&&err.stack?err.stack:'');}catch(_){}; return false; };
window.addEventListener('unhandledrejection',e=>{ try{log('PROMISE:',e.reason&&(e.reason.stack||e.reason));}catch(_){}; });

function z2(n){return String(n).padStart(2,'0')}
function ymd(d){return \`\${d.getFullYear()}-\${z2(d.getMonth()+1)}-\${z2(d.getDate())}\`}
function ymdhm(t){const d=new Date(t);return \`\${d.getFullYear()}-\${z2(d.getMonth()+1)}-\${z2(d.getDate())} \${z2(d.getHours())}:\${z2(d.getMinutes())}\`}
function normalizeText(t){ if(!t) return ''; t=t.replace(/<rt>.*?<\\/rt>/g,'').replace(/<[^>]+>/g,''); t=t.replace(/[\\s\\u3000]/g,'').replace(/[、，]/g,'、').replace(/[。．]/g,'。'); t=t.replace(/[「」『』（）()［］\\[\\]〈〉<>・… ,\\.\\-\\?\\!！?]/g,''); t=t.replace(/[Ａ-Ｚａ-ｚ０-９]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0)); return t; }
function isKanji(ch){ return /[\\u4E00-\\u9FFF\\u3400-\\u4DBF]/.test(ch); }
function academicYear(d){ const y=d.getFullYear(); const boundary=new Date(y,3,2); return (d>=boundary)?y:y-1; }
function parseGrade(label){ const m=String(label||'').match(/小\\s*([1-6])/); return m?Number(m[1]):1; }
function currentGradeNum(st){ const base=st.grade_base||parseGrade(st.grade||'小1'); const baseAy=st.grade_base_ay||academicYear(new Date(st.created_at||Date.now())); const delta=academicYear(new Date())-baseAy; return Math.min(6,Math.max(1,base+delta)); }
function currentGradeLabel(st){ return \`小\${currentGradeNum(st)}\`; }
function fmt2(x){ return (Math.round(Number(x)*100)/100).toFixed(2); }

/* ========= IndexedDB ========= */
const DB='oral_roles_v0213_lite'; // スキーマは同一、衝突回避のため名前だけ更新
let db;
function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(DB,1);
    r.onupgradeneeded=e=>{
      const db=e.target.result, tx=e.target.transaction;
      let s; if(!db.objectStoreNames.contains('students')) s=db.createObjectStore('students',{keyPath:'id',autoIncrement:true}); else s=tx.objectStore('students');
      if(!s.indexNames.contains('name')) s.createIndex('name','name');
      if(!s.indexNames.contains('school')) s.createIndex('school','school');
      if(!s.indexNames.contains('grade_base')) s.createIndex('grade_base','grade_base');
      if(!s.indexNames.contains('grade_base_ay')) s.createIndex('grade_base_ay','grade_base_ay');

      let sess; if(!db.objectStoreNames.contains('sessions')) sess=db.createObjectStore('sessions',{keyPath:'id',autoIncrement:true}); else sess=tx.objectStore('sessions');
      if(!sess.indexNames.contains('student_id')) sess.createIndex('student_id','student_id');
      if(!sess.indexNames.contains('created_at')) sess.createIndex('created_at','created_at');

      if(!db.objectStoreNames.contains('passages')) db.createObjectStore('passages',{keyPath:'no'});
      if(!db.objectStoreNames.contains('invites')) db.createObjectStore('invites',{keyPath:'token'});

      let g; if(!db.objectStoreNames.contains('guardians')) g=db.createObjectStore('guardians',{keyPath:'id',autoIncrement:true}); else g=tx.objectStore('guardians');
      if(!g.indexNames.contains('student_id')) g.createIndex('student_id','student_id');
    };
    r.onsuccess=()=>{ db=r.result; res(); };
    r.onerror=()=>rej(r.error);
  });
}
function tx(name,mode='readonly'){ return db.transaction(name,mode).objectStore(name); }
const idb={
  addStudent:(obj)=>new Promise((res,rej)=>{ const s={...obj,created_at:obj.created_at||Date.now()}; const r=tx('students','readwrite').add(s); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }),
  delStudent:id=>new Promise((res,rej)=>{ const r=tx('students','readwrite').delete(id); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }),
  listStudents:()=>new Promise((res,rej)=>{ const out=[]; const c=tx('students').openCursor(); c.onsuccess=e=>{ const cur=e.target.result; if(cur){ out.push({...cur.value,id:cur.primaryKey}); cur.continue(); } else res(out); }; c.onerror=()=>rej(c.error); }),
  savePassage:(no,title,text)=>new Promise((res,rej)=>{ const r=tx('passages','readwrite').put({no:String(no),title,text}); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }),
  delPassage:no=>new Promise((res,rej)=>{ const r=tx('passages','readwrite').delete(String(no)); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }),
  getPassage:no=>new Promise((res,rej)=>{ const r=tx('passages').get(String(no)); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); }),
  listPassages:()=>new Promise((res,rej)=>{ const out=[]; const c=tx('passages').openCursor(); c.onsuccess=e=>{ const cur=e.target.result; if(cur){ out.push(cur.value); cur.continue(); } else res(out); }; c.onerror=()=>rej(c.error); }),
  saveSession:s=>new Promise((res,rej)=>{ const r=tx('sessions','readwrite').add(s); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }),
  listSessions:(studentId=null,startMs=null,endMs=null)=>new Promise((res,rej)=>{
    const out=[]; const store=tx('sessions');
    const req=studentId?store.index('student_id').openCursor(IDBKeyRange.only(studentId)):store.openCursor();
    req.onsuccess=e=>{ const cur=e.target.result; if(cur){ const v={...cur.value,id:cur.primaryKey}; if((startMs==null||v.created_at>=startMs)&&(endMs==null||v.created_at<endMs)) out.push(v); cur.continue(); } else res(out.sort((a,b)=>b.created_at-a.created_at)); };
    req.onerror=()=>rej(req.error);
  })
};

/* ========= 認証/ナビ ========= */
function teacherAuthed(){ try{return localStorage.getItem('teacher_auth')==='1'}catch(_){return false} }
function guardianAuthed(){ try{return localStorage.getItem('guardian_auth')==='1'}catch(_){return false} }
function setAutoPref(on){ try{localStorage.setItem('autojump',on?'1':'0')}catch(_){} }
function enterRole(role){
  try{ const chk=qs('#rememberRole'); if(chk) setAutoPref(chk.checked); localStorage.setItem('last_role',role);}catch(_){}
  if(role==='s') location.hash='#/s';
  else if(role==='g') location.hash='#/g';
  else if(role==='t') location.hash='#/t';
  setActiveTab();
}
function loginTeacher(){
  const id=(qs('#loginId')?.value||'').trim();
  const pw=(qs('#loginPw')?.value||'').trim();
  if(id==='surasura'&&pw==='surasura'){ try{localStorage.setItem('teacher_auth','1')}catch(_){} enterRole('t'); }
  else alert('IDまたはパスワードが違います');
}
async function guardGuardian(){
  if(guardianAuthed()) return true;
  const pw=prompt('保護者パスワード（開発中：mama）');
  if(pw==='mama'){ try{localStorage.setItem('guardian_auth','1')}catch(_){} return true; }
  alert('パスワードが違います'); return false;
}
function updateTopNav(){ const t=qs('#tabT'); t.style.display=teacherAuthed()?'inline-block':'none'; qs('#tabG').style.display='inline-block'; }
function setActiveTab(){
  let raw=location.hash||'#/start'; let h=raw.split('?')[0];
  if(h.startsWith('#/t')&&!teacherAuthed()){ h='#/start'; if(location.hash!=='#/start'){location.hash='#/start';} }
  if(h.startsWith('#/g')&&!guardianAuthed()){
    (async()=>{ const ok=await guardGuardian(); if(ok){location.hash='#/g'; setActiveTab();} else {location.hash='#/start'; setActiveTab();} })();
    h='#/start';
  }
  qsa('a.tab').forEach(a=>a.classList.remove('active'));
  if(h.startsWith('#/s')) qs('#tabS').classList.add('active');
  else if(h.startsWith('#/t')) qs('#tabT').classList.add('active');
  else if(h.startsWith('#/g')) qs('#tabG').classList.add('active');

  const onLanding=(h==="#/start"||h==="#/");
  const cover=qs('#landingCover'); if(cover){ cover.classList.toggle('hidden',!onLanding); }
  document.body.classList.toggle('landing-active',onLanding);
  qs('#viewS').classList.toggle('hidden',!h.startsWith('#/s'));
  qs('#viewT').classList.toggle('hidden',!h.startsWith('#/t'));
  qs('#viewG').classList.toggle('hidden',!h.startsWith('#/g'));
  updateTopNav();
  if(h.startsWith('#/t')) refreshTeacher();
  if(h.startsWith('#/g')) initGuardianToday();
}
window.addEventListener('hashchange',setActiveTab);
setTimeout(()=>{
  // 上部タブ
  qsa('a.tab').forEach(a=>a.addEventListener('click',e=>{
    const href=a.getAttribute('href'); if(!href) return;
    e.preventDefault();
    if(href==="#/t"&&!teacherAuthed()){ location.hash='#/start'; setActiveTab(); qs('#loginId')?.focus(); return; }
    if(href==="#/g"&&!guardianAuthed()){ guardGuardian().then(ok=>{ if(ok){location.hash='#/g'; setActiveTab();} }); return; }
    location.hash=href; setActiveTab();
  }));
  // ランディングのタイル
  qs('#goS')?.addEventListener('click',e=>{ e.preventDefault(); enterRole('s'); });
  qs('#goSkip')?.addEventListener('click',e=>{ e.preventDefault(); enterRole('s'); });
  qs('#goG')?.addEventListener('click',async e=>{ e.preventDefault(); const ok=await guardGuardian(); if(ok) enterRole('g'); });
  qs('#goT')?.addEventListener('click',e=>{ e.preventDefault(); if(teacherAuthed()) enterRole('t'); else { location.hash='#/start'; setActiveTab(); qs('#loginId')?.focus(); } });

  qs('#loginBtn')?.addEventListener('click',loginTeacher);
  qs('#loginId')?.addEventListener('keydown',e=>{ if(e.key==='Enter') loginTeacher(); });
  qs('#loginPw')?.addEventListener('keydown',e=>{ if(e.key==='Enter') loginTeacher(); });
},0);

/* ========= 録音 / ASR ========= */
let mediaStream,audioCtx,analyser,procNode,recorder,recChunks=[],isPaused=false,rafId=null;
let asr=null; // ← v0.2.13 で追加（停止漏れ対策）

function startViz(){
  const canvas=qs('#viz'); if(!canvas||!analyser) return;
  const ctx=canvas.getContext('2d'); const {width,height}=canvas; const data=new Uint8Array(analyser.fftSize);
  function draw(){
    analyser.getByteTimeDomainData(data);
    ctx.clearRect(0,0,width,height);
    ctx.beginPath(); const mid=height/2;
    for(let x=0;x<width;x++){
      const i=Math.floor(x/data.length*data.length);
      const y=(data[i]-128)/128* (height*0.4);
      if(x===0) ctx.moveTo(x,mid+y); else ctx.lineTo(x,mid+y);
    }
    ctx.strokeStyle='#cfe6ff'; ctx.lineWidth=2; ctx.stroke();
    rafId=requestAnimationFrame(draw);
  }
  cancelAnimationFrame(rafId); rafId=requestAnimationFrame(draw);
}
function stopViz(){ if(rafId){ cancelAnimationFrame(rafId); rafId=null; const c=qs('#viz'); c&&c.getContext('2d').clearRect(0,0,c.width,c.height); }

async function startRec(){
  mediaStream=await navigator.mediaDevices.getUserMedia({audio:true});
  recorder=new MediaRecorder(mediaStream);
  recChunks=[]; recorder.ondataavailable=e=>{ if(e.data.size>0) recChunks.push(e.data); };
  recorder.start();
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const src=audioCtx.createMediaStreamSource(mediaStream);
  analyser=audioCtx.createAnalyser(); analyser.fftSize=1024;
  procNode=audioCtx.createScriptProcessor(1024,1,1); procNode.onaudioprocess=e=>{};
  src.connect(analyser); analyser.connect(procNode); procNode.connect(audioCtx.destination);
  qs('#readingText').classList.add('reading-anim');
  startViz();
}
async function pauseRec(){ if(!recorder) return; if('pause' in recorder && recorder.state==='recording'){ recorder.pause(); isPaused=true; } }
async function resumeRec(){ if(!recorder) return; if('resume' in recorder && recorder.state==='paused'){ recorder.resume(); isPaused=false; } }
async function stopRec(){
  try{ recorder && recorder.state!=='inactive' && recorder.stop(); }catch(_){} 
  try{ mediaStream && mediaStream.getTracks().forEach(t=>t.stop()); }catch(_){}
  try{ procNode && procNode.disconnect(); analyser && analyser.disconnect(); }catch(_){}
  if(audioCtx){ try{ await audioCtx.close(); }catch(_){} }
  qs('#readingText').classList.remove('reading-anim');
  stopViz();
  // v0.2.13: ASR を確実に停止
  try{ if(asr){ asr.onresult=null; asr.onend=null; asr.onerror=null; asr.stop(); } }catch(_){}
  asr=null;
}
function startASR(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert('このブラウザはWeb Speech APIに未対応です。Chromeをお試しください。'); return false; }
  asr=new SR(); asr.lang='ja-JP'; asr.interimResults=true; asr.continuous=true;
  let asrText=''; const area=qs('#asrText');
  asr.onresult=e=>{
    let tmp=''; for(let i=e.resultIndex;i<e.results.length;i++){ const r=e.results[i]; if(r.isFinal) asrText+=r[0].transcript; else tmp+=r[0].transcript; }
    area.value=asrText+tmp;
  };
  asr.onend=()=>{ log('ASR end'); }; // 必要なら再開ロジックを追加
  asr.onerror=ev=>{ log('ASR error',ev&&ev.error); };
  asr.start(); return true;
}

/* ========= 採点（簡易） ========= */
function analyzeLite(refRaw,hypRaw){
  const ref=normalizeText(refRaw), hyp=normalizeText(hypRaw);
  const cpm=Math.round(hyp.length/Math.max(1e-6,1));
  const cer=ref.length?Math.max(0,Math.min(1,(ref.length-hyp.length)/ref.length)):0;
  const overall=Math.max(0,Math.min(100,Math.round(85-cer*40+Math.min(20,Math.floor(cpm/30)))));
  return {cpm,cer,f0range:0,prosodyScore:0,overall,missList:[],refHtml:refRaw,hypHtml:hypRaw};
}

/* ========= 生徒 UI ========= */
let currentStudentId=Number(localStorage.getItem('student_id')||0);
function updateStudentBadge(){
  if(!currentStudentId){ qs('#studentBadge').textContent='未設定'; return; }
  idb.listStudents().then(l=>{ const st=l.find(x=>x.id===currentStudentId); qs('#studentBadge').textContent=st? \`\${st.name}（\${currentGradeLabel(st)}）\`:'未設定'; });
}
async function chooseStudent(){
  const list=await idb.listStudents();
  if(!list.length){ alert('まず講師画面（#/t）で生徒を追加してください。'); return; }
  const name=prompt('生徒名を選んで入力してください\\n'+list.map(s=>\`・\${s.name}（\${currentGradeLabel(s)}｜\${s.school||'学校'}）\`).join('\\n'));
  const found=list.find(s=>s.name===name);
  if(!found){ alert('見つかりませんでした'); return; }
  currentStudentId=found.id; localStorage.setItem('student_id',String(currentStudentId));
  updateStudentBadge(); refreshStudentTexts(); updateStreakUI();
}
async function loadPassageByNo(no){
  const p=await idb.getPassage(no);
  if(!p){ alert('登録されていない番号です'); return; }
  qs('#readingText').textContent=p.text||''; qs('#passageS').value=p.text||''; qs('#readingText').scrollTop=0;
}
async function refreshStudentTexts(){
  const sel=qs('#textSelectS'); if(!sel) return; sel.innerHTML='';
  const passages=await idb.listPassages();
  const rows=await idb.listSessions(currentStudentId);
  const countByNo={}; rows.forEach(r=>{ const k=r.text_no; countByNo[k]=(countByNo[k]||0)+1; });
  passages.sort((a,b)=>String(a.no).localeCompare(String(b.no))).forEach(p=>{
    const n=countByNo[p.no]||0; const o=document.createElement('option');
    o.value=p.no; o.textContent=\`\${p.no} \${p.title||''}（\${n}回）\`; sel.appendChild(o);
  });
  // 最初の1件を本文に反映（空なら何もしない）
  if(passages.length){ loadPassageByNo(passages[0].no); sel.value=passages[0].no; }
}

/* フォントサイズ：保存＆復元 */
function applyFontSize(px){ qs('#readingText').style.fontSize=px+'px'; try{ localStorage.setItem('reading_font_px',String(px)); }catch(_){} }
(function restoreFont(){ const px=Number(localStorage.getItem('reading_font_px')||28); applyFontSize(px); })();

qs('#setStudentBtn').onclick=chooseStudent;
qs('#loadPassageBtn').onclick=()=>{
  const typed=qs('#textNo').value.trim();
  const sel=qs('#textSelectS').value;
  const no=typed||sel;
  if(no) loadPassageByNo(no);
};
qs('#textSelectS').addEventListener('change',e=>{ const no=e.target.value; if(no) loadPassageByNo(no); });
qsa('.fontBtn').forEach(b=> b.addEventListener('click',()=>{ const sz=Number(b.dataset.size||28); applyFontSize(sz); }));

qs('#startBtn').onclick= async ()=>{
  qs('#startBtn').disabled=true; qs('#stopBtn').disabled=false; qs('#pauseBtn').disabled=false; qs('#saveBtn').disabled=true; qs('#dlAudioBtn').disabled=true; isPaused=false;
  await startRec(); const ok=startASR();
  if(!ok){ qs('#startBtn').disabled=false; qs('#stopBtn').disabled=true; qs('#pauseBtn').disabled=true; }
};
qs('#pauseBtn').onclick= async ()=>{ if(!recorder) return;
  if(isPaused){ await resumeRec(); qs('#pauseBtn').textContent='⏸ 一時停止'; }
  else { await pauseRec(); qs('#pauseBtn').textContent='▶ 再開'; }
};
qs('#stopBtn').onclick= async ()=>{
  await stopRec();
  qs('#startBtn').disabled=false; qs('#stopBtn').disabled=true; qs('#pauseBtn').disabled=true; qs('#pauseBtn').textContent='⏸ 一時停止'; qs('#dlAudioBtn').disabled=false;
};
qs('#dlAudioBtn').onclick=()=>{
  if(!recChunks.length) return;
  const blob=new Blob(recChunks,{type:'audio/webm'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=\`reading_\${Date.now()}.webm\`; a.click();
};
function speakResult(overall){ try{ const s=new SpeechSynthesisUtterance(\`採点結果、総合 \${overall} 点。おつかれさま。\`); s.lang='ja-JP'; speechSynthesis.speak(s);}catch(_){} }

async function updateStreakUI(){
  if(!currentStudentId){ qs('#streak').textContent='0'; qs('#totalDays').textContent='0'; return; }
  const rows=await idb.listSessions(currentStudentId);
  const days=[...new Set(rows.map(r=>ymd(new Date(r.created_at))))].sort();
  const total=days.length; let streak=0;
  if(total){
    let cur=new Date(); cur.setHours(0,0,0,0); let i=days.length-1;
    const todayStr=ymd(cur);
    if(days[i]!==todayStr){ cur.setDate(cur.getDate()-1); }
    while(i>=0){ const dstr=ymd(cur); if(days[i]===dstr){ streak++; i--; cur.setDate(cur.getDate()-1); } else break; }
  }
  qs('#streak').textContent=String(streak); qs('#totalDays').textContent=String(total);
}

qs('#analyzeBtn').onclick=()=>{
  const refRaw=qs('#passageS').value.trim()||qs('#readingText').textContent.trim();
  const hypRaw=qs('#asrText').value.trim();
  if(!refRaw||!hypRaw){ alert('本文と認識結果が必要です'); return; }
  const r=analyzeLite(refRaw,hypRaw);
  qs('#speedCpm').textContent=r.cpm; qs('#cer').textContent=fmt2(r.cer); qs('#f0range').textContent=r.f0range; qs('#prosodyScore').textContent=r.prosodyScore; qs('#overall').textContent=r.overall;
  qs('#missKanjis').textContent=r.missList.join('　'); qs('#refHl').innerHTML=r.refHtml; qs('#hypHl').innerHTML=r.hypHtml;
  qs('#scoreStatus').textContent='採点済み'; qs('#saveBtn').disabled=false;
  qs('#saveBtn').onclick= async ()=>{
    if(!currentStudentId){ alert('この端末の生徒を設定してください'); return; }
    const no=(qs('#textSelectS').value||qs('#textNo').value||'').trim();
    const row={created_at:Date.now(),student_id:currentStudentId,text_no:no,cpm:r.cpm,cer:r.cer,f0range:r.f0range,prosodyScore:r.prosodyScore,overall:r.overall,miss_kanji:{}};
    await idb.saveSession(row); await updateStreakUI(); qs('#scoreStatus').textContent='保存済み'; speakResult(r.overall); alert('保存しました');
  };
};

/* ========= 講師 ========= */
async function refreshTeacher(){
  const list=await idb.listStudents();
  const schoolF=(qs('#searchSchool')?.value.trim())||'';
  const gradeF=(qs('#searchGrade')?.value)||'';
  const filtered=list.filter(s=>{
    const okSchool=!schoolF||(String(s.school||'').includes(schoolF));
    const okGrade=!gradeF||(currentGradeNum(s)===Number(gradeF));
    return okSchool&&okGrade;
  });
  const sel=qs('#studentList'); if(sel){ sel.innerHTML=''; filtered.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=\`\${s.name}（\${currentGradeLabel(s)}｜\${s.school||'学校未登録'}）\`; sel.appendChild(o); }); }
  await listPassages(); await refreshToday();
}
qs('#addStudentBtn').onclick= async ()=>{
  const name=qs('#studentName').value.trim(); const school=qs('#studentSchool').value.trim(); const gradeLabel=qs('#studentGrade').value;
  if(!name) return alert('氏名を入れてください');
  const s={name,school,grade:gradeLabel,grade_base:parseGrade(gradeLabel),grade_base_ay:academicYear(new Date())};
  await idb.addStudent(s);
  qs('#studentName').value=''; qs('#studentSchool').value='';
  await refreshTeacher();
};
qs('#delStudentBtn').onclick= async ()=>{
  const id=Number(qs('#studentList').value||0); if(!id) return;
  if(!confirm('この生徒を削除しますか（履歴は残ります）？')) return;
  await idb.delStudent(id); await refreshTeacher();
};

/* テキスト管理 */
async function listPassages(){
  const t=qs('#passageTable tbody'); if(!t) return; t.innerHTML='';
  const rows=await idb.listPassages();
  rows.sort((a,b)=>String(a.no).localeCompare(String(b.no)));
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=\`<td>\${r.no}</td><td>\${r.title||''}</td><td>\${(r.text||'').slice(0,22)}…</td>\`;
    tr.onclick=()=>{ qs('#textNoT').value=r.no; qs('#titleT').value=r.title||''; qs('#passageT').value=r.text||''; };
    t.appendChild(tr);
  });
}
qs('#savePassageBtn').onclick= async ()=>{
  const no=qs('#textNoT').value.trim(); const title=qs('#titleT').value.trim(); const text=qs('#passageT').value.trim();
  if(!no||!text) return alert('番号と本文を入れてください');
  await idb.savePassage(no,title,text); await listPassages(); alert('保存/更新しました');
};
qs('#delPassageBtn').onclick= async ()=>{
  const no=qs('#textNoT').value.trim(); if(!no) return;
  if(!confirm('削除しますか？')) return;
  await idb.delPassage(no); await listPassages();
};
qs('#listPassagesBtn').onclick=listPassages;

/* 今日のダイジェスト */
async function refreshToday(){
  const today=new Date(); today.setHours(0,0,0,0);
  const start=today.getTime(), end=start+86400000;
  const rows=await idb.listSessions(null,start,end);
  const t=qs('#todayTable tbody'); if(t) t.innerHTML='';
  const students=await idb.listStudents(); const sMap=new Map(students.map(s=>[s.id,s]));
  rows.forEach(r=>{
    const st=sMap.get(r.student_id)||{name:'?',grade:'?',school:''};
    if(t){ const tr=document.createElement('tr'); tr.innerHTML=\`<td>\${ymdhm(r.created_at)}</td><td>\${st.name}</td><td>\${currentGradeLabel(st)}</td><td>\${r.text_no||''}</td><td>\${r.cpm}</td><td>\${fmt2(r.cer)}</td><td>\${r.f0range}</td><td>\${r.overall}</td>\`; t.appendChild(tr); }
  });
}
qs('#refreshTodayBtn').onclick=refreshToday;
qs('#searchStudentsBtn')?.addEventListener('click',refreshTeacher);
qs('#searchSchool')?.addEventListener('keydown',e=>{ if(e.key==='Enter') refreshTeacher(); });
qs('#searchGrade')?.addEventListener('change',refreshTeacher);
qs('#exportCsvBtn').onclick= async ()=>{
  const rows=await idb.listSessions();
  const hdr=['datetime','student','grade_current','text_no','cpm','cer','f0range','prosody','overall'];
  const students=await idb.listStudents(); const sMap=new Map(students.map(s=>[s.id,s]));
  const lines=[hdr.join(',')];
  rows.forEach(r=>{
    const st=sMap.get(r.student_id)||{name:'?',grade:'?',school:''};
    const vals=[new Date(r.created_at).toISOString(),st.name,currentGradeLabel(st),r.text_no||'',r.cpm,fmt2(r.cer),r.f0range,r.prosodyScore||0,r.overall].map(v=>\`"\${String(v).replace(/"/g,'""')}"\`);
    lines.push(vals.join(','));
  });
  const blob=new Blob([lines.join('\\n')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='oral_reading_history.csv'; a.click();
};

/* ========= 保護者（当日分のみ） ========= */
async function initGuardianToday(){
  const sid=Number(localStorage.getItem('guardian_student_id')||0);
  if(!sid){ qs('#gStudent').textContent='未連携'; return; }
  const st=(await idb.listStudents()).find(s=>s.id===sid);
  qs('#gStudent').textContent=st? \`\${st.name}（\${currentGradeLabel(st)}）\`:'未連携';
  const today=new Date(); today.setHours(0,0,0,0);
  const rows=await idb.listSessions(sid,today.getTime(),today.getTime()+86400000);
  const tb=qs('#gTable tbody'); if(tb) tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=\`<td>\${ymdhm(r.created_at)}</td><td>\${r.text_no||''}</td><td>\${r.cpm}</td><td>\${fmt2(r.cer)}</td><td>\${r.overall}</td>\`;
    tb?.appendChild(tr);
  });
}
qs('#gInstallBtn').onclick=()=>{ alert('ホーム画面に追加：\\n1) 右上メニュー（⋮ / 共有）→「ホーム画面に追加」\\n2) 追加後はそのアイコンから起動できます。'); };

/* ========= サンプル注入 ========= */
async function injectSamplesIfEmpty(){
  const ps=await idb.listPassages(); if(ps.length>=5) return;
  for(let g=1; g<=6; g++){
    for(let i=1;i<=10;i++){
      const no=\`G\${g}-\${String(i).padStart(3,'0')}\`;
      const title=\`小\${g}サンプル\${String(i).padStart(2,'0')}\`;
      const text=\`小\${g}のサンプル文章 \${String(i).padStart(2,'0')}。きょうは良い天気です。川のながれがきらきら光ります。\`;
      await idb.savePassage(no,title,text);
    }
  }
}

/* ========= 初期化 ========= */
function autoJump(){
  try{
    const auto=localStorage.getItem('autojump')==='1';
    const last=localStorage.getItem('last_role');
    const atStart=(!location.hash||location.hash==='#'||location.hash==='#/'||location.hash==='#/start');
    if(auto && atStart && last){
      if(last==='t'){ if(teacherAuthed()) location.hash='#/t'; }
      else if(last==='s') location.hash='#/s';
      else if(last==='g'){ if(guardianAuthed()) location.hash='#/g'; }
    }
  }catch(_){}
}
async function init(){
  await openDB(); await injectSamplesIfEmpty();
  autoJump(); setActiveTab(); updateStreakUI(); refreshStudentTexts();
}
window.addEventListener('load',init);
</script>
</body>
</html>
