<!-- 2025-09-27 15:30 JST | Version: V0.2.10 -->
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>音読SURASURA（Roles） V0.2.10</title>
<meta name="theme-color" content="#0b1020">
<!-- Build: 2025-09-27 15:30 JST | Version: V0.2.10 -->
<style>
:root{--bg:#0b1020;--panel:#111827;--ink:#e6f1ff;--muted:#8aa0bf;--accent:#4f8cff;--ok:#20e3c2;--warn:#ffce3a;--bad:#ff6b6b;--shadow:0 10px 24px rgba(0,0,0,.45)}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
header{position:sticky;top:0;background:linear-gradient(180deg,rgba(0,0,0,.5),transparent),var(--panel);padding:10px 14px;box-shadow:var(--shadow);z-index:50}
h1{margin:0;font-size:18px}
small.ver{color:#8aa0bf;margin-left:8px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#1e293b;color:#cfe6ff;border:1px solid #2a3a56;font-size:12px}
.note{color:#9bb2d1;font-size:12px}
.wrapper{display:grid;grid-template-columns:1fr;gap:16px;padding:14px;max-width:980px;margin:0 auto}
.card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;box-shadow:var(--shadow);padding:14px}
.card h2{margin:4px 0 10px 0;font-size:16px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
input,select,button,textarea{background:#0c1322;color:var(--ink);border:1px solid #233047;border-radius:12px;padding:10px 12px;font-size:14px}
textarea{width:100%;min-height:120px;line-height:1.6}
button{cursor:pointer}
button.primary{background:var(--accent);border-color:#2f63d1}
button.good{background:var(--ok);border-color:#17b79b;color:#06231d}
button.warn{background:var(--warn);border-color:#b69200;color:#261e00}
button.danger{background:#d44;border-color:#b22}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #24324a;padding:8px;font-size:13px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.hidden{display:none!important}
.kbd{border:1px solid #334155;background:#0b1322;padding:2px 6px;border-radius:6px;font-size:12px}
hr{border:none;border-top:1px solid #203049;margin:12px 0}
.flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto}
.tabnav{display:flex;gap:8px}
a.tab{color:#cfe6ff;text-decoration:none;border:1px solid #2a3a56;border-radius:999px;padding:6px 10px}
a.tab.active{background:#24324a}
.hl-miss{background:#3a1020;color:#ffd7de;border-bottom:1px dashed #ff6b6b}
canvas{background:#0b1322;border:1px solid #233047;border-radius:12px}
@media (max-width:640px){header h1{font-size:16px}button{padding:12px 14px}textarea{min-height:96px}#viz{height:80px}}
/* Landing overlay */
.landing-cover{position:fixed;inset:0;z-index:2147483647;display:grid;place-items:center;background:#0b1020}
.landing-cover::before{content:"";position:absolute;inset:0;background:radial-gradient(80% 60% at 50% 10%,rgba(79,140,255,.15),transparent),linear-gradient(180deg,rgba(0,0,0,.88),rgba(0,0,0,.96));pointer-events:none}
.landing-panel{position:relative;width:min(760px,92vw);border-radius:20px;background:var(--panel);border:1px solid #22324a;box-shadow:var(--shadow);padding:22px}
.landing-panel h1{font-size:24px;margin:0 0 8px 0}
.landing-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:640px){.landing-grid{grid-template-columns:1fr}}
body.landing-active header, body.landing-active main{visibility:hidden}
</style>
</head>
<body>
<header>
  <div class="flex">
    <div>
      <h1>音読SURASURA（ロール切替）<small class="ver">V0.2.10</small></h1>
      <div class="note">#/start=入口｜#/s=生徒｜#/t=講師｜#/g=保護者｜?debug=1でログ</div>
    </div>
    <nav class="tabnav right">
      <a id="tabS" href="#/s" class="tab">生徒</a>
      <a id="tabT" href="#/t" class="tab">講師</a>
      <a id="tabG" href="#/g" class="tab">保護者</a>
      <span id="dbg" class="badge hidden">DEBUG</span>
    </nav>
  </div>
</header>

<!-- Landing overlay -->
<div id="landingCover" class="landing-cover">
  <div class="landing-panel">
    <h1>音読SURASURA</h1>
    <div class="note">ロールを選んでください（生徒/保護者/スキップはボタンだけ、講師は簡易ログイン）</div>
    <div class="landing-grid" style="margin:12px 0 6px">
      <button id="goS" class="primary" style="font-size:18px;padding:16px 18px">生徒で入る</button>
      <button id="goG" class="primary" style="font-size:18px;padding:16px 18px">保護者で入る</button>
      <button id="goSkip" style="font-size:18px;padding:16px 18px">スキップ（見学）</button>
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="rememberRole"> 次回からこのロールで開く</label>
    </div>
    <hr>
    <h3 style="margin:8px 0 6px">講師ログイン（開発中）</h3>
    <div class="landing-grid">
      <input id="loginId" placeholder="ID">
      <input id="loginPw" type="password" placeholder="パスワード">
      <button id="loginBtn" class="primary">ログイン</button>
      <div class="note">テストID/PW: <span class="kbd">surasura / surasura</span></div>
    </div>
  </div>
</div>

<main class="wrapper">
  <!-- Student -->
  <section id="viewS" class="card hidden">
    <h2>生徒｜音読</h2>
    <div class="row">
      <span>この端末の生徒：</span>
      <span id="studentBadge" class="badge">未設定</span>
      <button id="setStudentBtn">生徒を設定</button>
    </div>
    <div class="row">
      <input id="textNo" placeholder="テキスト番号（例：1001）" inputmode="numeric" style="flex:1">
      <button id="loadPassageBtn">読込</button>
    </div>
    <textarea id="passageS"></textarea>
    <div class="row">
      <button id="startBtn" class="primary">録音開始</button>
      <button id="stopBtn" class="danger" disabled>停止</button>
      <span id="recStatus" class="badge">準備OK</span>
    </div>
    <div class="row">
      <label>認識（自動）</label>
      <textarea id="asrText" class="mono" placeholder="ここに認識結果が入ります"></textarea>
    </div>
    <canvas id="viz" width="600" height="120" style="width:100%;height:120px"></canvas>
    <div class="row">
      <button id="analyzeBtn" class="good">採点</button>
      <span id="scoreStatus" class="badge">未採点</span>
      <button id="saveBtn" disabled>保存</button>
      <button id="dlAudioBtn" class="warn" disabled>音声DL</button>
    </div>
    <div id="scoreBox">
      <ul class="flex">
        <li class="badge">速度 <b id="speedCpm">-</b> 文字/分</li>
        <li class="badge">CER <b id="cer">-</b></li>
        <li class="badge">F0レンジ <b id="f0range">-</b> Hz</li>
        <li class="badge">抑揚 <b id="prosodyScore">-</b>/20</li>
        <li class="badge">総合 <b id="overall">-</b>/100</li>
      </ul>
      <div style="margin-top:8px"><b>誤読（推定）</b>：<span id="missKanjis" class="mono"></span></div>
    </div>
    <hr>
    <div><b>正解：</b> <span id="refHl"></span></div>
    <div><b>読上：</b> <span id="hypHl"></span></div>
  </section>

  <!-- Teacher -->
  <section id="viewT" class="card hidden">
    <h2>講師｜管理・日次ダイジェスト</h2>
    <div class="card" style="margin:-4px 0 10px 0">
      <h3>1) 生徒管理</h3>
      <div class="row">
        <input id="studentName" placeholder="氏名">
        <input id="studentSchool" placeholder="学校名">
        <select id="studentGrade">
          <option>小1</option><option>小2</option><option>小3</option>
          <option selected>小4</option><option>小5</option><option>小6</option>
        </select>
        <button id="addStudentBtn" class="primary">生徒追加</button>
      </div>
      <div class="row">
        <input id="searchSchool" placeholder="学校で絞り込み（任意）">
        <select id="searchGrade">
          <option value="">学年で絞り込み（任意）</option>
          <option value="1">小1</option><option value="2">小2</option><option value="3">小3</option>
          <option value="4">小4</option><option value="5">小5</option><option value="6">小6</option>
        </select>
        <button id="searchStudentsBtn">検索</button>
      </div>
      <div class="row">
        <label>生徒一覧：</label>
        <select id="studentList"></select>
        <button id="delStudentBtn" class="danger">削除</button>
      </div>
    </div>

    <div class="card" style="margin:-4px 0 10px 0">
      <h3>2) テキスト番号管理</h3>
      <div class="row">
        <input id="textNoT" placeholder="番号（例：1001）" style="width:140px">
        <input id="titleT" placeholder="タイトル（任意）" style="flex:1">
        <button id="savePassageBtn" class="primary">保存/更新</button>
      </div>
      <textarea id="passageT" placeholder="本文（ふりがな可）"></textarea>
      <div class="row">
        <button id="listPassagesBtn">番号一覧を表示</button>
        <button id="delPassageBtn" class="danger">削除</button>
      </div>
      <table class="table" id="passageTable"><thead><tr><th>番号</th><th>タイトル</th><th>先頭プレビュー</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="card" style="margin:-4px 0 10px 0">
      <h3>3) 保護者招待（リンク作成）</h3>
      <div class="row">
        <label>対象生徒：</label>
        <select id="guardianStudent"></select>
        <input id="guardianMail" type="email" placeholder="保護者メール（任意）">
        <button id="genInviteBtn" class="primary">招待リンク作成</button>
      </div>
      <div class="row">
        <input id="inviteLink" placeholder="ここにリンクが表示されます" style="flex:1">
        <button id="copyInviteBtn">コピー</button>
        <a id="mailtoBtn" class="badge" href="#" target="_blank">メール作成</a>
      </div>
      <div class="note">※ 自動送信なし。作成したリンクをメールで送ってください。</div>
    </div>

    <div class="card" style="margin:-4px 0 10px 0">
      <h3>4) 今日のダイジェスト</h3>
      <div class="row"><button id="refreshTodayBtn">更新</button>
        <button id="exportCsvBtn" class="warn">CSVエクスポート</button>
      </div>
      <table class="table" id="todayTable"><thead><tr>
        <th>時刻</th><th>生徒</th><th>学年</th><th>番号</th><th>速度</th><th>CER</th><th>F0</th><th>総合</th>
      </tr></thead><tbody></tbody></table>
      <h4>誤読漢字ランキング（本日）</h4>
      <div id="kanjiRankToday" class="mono"></div>
    </div>
  </section>

  <!-- Guardian -->
  <section id="viewG" class="card hidden">
    <h2>保護者｜本日の結果</h2>
    <div id="guardianBind" class="note">招待リンクからアクセスすると、お子さまと連携されます。</div>
    <div class="row">
      <span>お子さま：</span> <span id="gStudent" class="badge">未連携</span>
      <button id="gInstallBtn">ホーム画面に追加の手順</button>
    </div>
    <table class="table" id="gTable"><thead><tr>
      <th>日時</th><th>番号</th><th>速度</th><th>CER</th><th>総合</th>
    </tr></thead><tbody></tbody></table>
    <div class="note">※ 音声は既定で保存しません（保護者同意時のみ保存ONにできます）。</div>
  </section>

  <section class="card">
    <h2>ログ</h2>
    <pre id="log" class="mono" style="white-space:pre-wrap;max-height:160px;overflow:auto"></pre>
  </section>
</main>

<script>
/* ===== Helpers ===== */
var qs=function(s){return document.querySelector(s)}, qsa=function(s){return Array.from(document.querySelectorAll(s))};
var debug=(new URLSearchParams(location.search).get('debug')==='1');
if(debug){var dbe=qs('#dbg'); if(dbe)dbe.classList.remove('hidden');}
function log(){ if(!debug) return; var el=qs('#log'); var a=[].slice.call(arguments); el.textContent+=a.join(' ')+'\n'; el.scrollTop=el.scrollHeight; }
window.onerror=function(m,src,ln,col,err){ try{log('ERROR:',m,src+':'+ln+':'+col,(err&&err.stack)?err.stack:'');}catch(e){} return false; };
window.addEventListener('unhandledrejection', function(e){ try{log('REJECTION:', e.reason && (e.reason.stack||e.reason));}catch(x){} });
function z2(n){ return String(n).padStart(2,'0'); }
function ymdhm(t){ var d=new Date(t); return d.getFullYear()+'-'+z2(d.getMonth()+1)+'-'+z2(d.getDate())+' '+z2(d.getHours())+':'+z2(d.getMinutes()); }
function normalizeText(t){ if(!t) return ''; t=t.replace(/<rt>.*?<\/rt>/g,'').replace(/<[^>]+>/g,''); t=t.replace(/[\s\u3000]/g,'').replace(/[、，]/g,'、').replace(/[。．]/g,'。'); t=t.replace(/[「」『』（）()［］\[\]〈〉<>・… ,\.\-\?\!！?]/g,''); t=t.replace(/[Ａ-Ｚａ-ｚ０-９]/g,function(s){return String.fromCharCode(s.charCodeAt(0)-0xFEE0)}); return t; }
function isKanji(ch){ return /[\u4E00-\u9FFF\u3400-\u4DBF]/.test(ch); }
function academicYear(d){ var y=d.getFullYear(); var boundary=new Date(y,3,2); return (d>=boundary)? y : y-1; }
function parseGrade(label){ var m=String(label||'').match(/小\s*([1-6])/); return m?Number(m[1]):1; }
function currentGradeNum(st){ var base=st.grade_base||parseGrade(st.grade||'小1'); var baseAy=st.grade_base_ay||academicYear(new Date(st.created_at||Date.now())); var delta=academicYear(new Date())-baseAy; var v=base+delta; if(v<1)v=1; if(v>6)v=6; return v; }
function currentGradeLabel(st){ return '小'+currentGradeNum(st); }

/* ===== DB ===== */
var DB='oral_roles_v0210'; var db;
function openDB(){ return new Promise(function(res,rej){ var r=indexedDB.open(DB,1); r.onupgradeneeded=function(e){ var db=e.target.result; var tx=e.target.transaction; var s; if(!db.objectStoreNames.contains('students')){ s=db.createObjectStore('students',{keyPath:'id',autoIncrement:true}); } else { s=tx.objectStore('students'); } if(!s.indexNames.contains('name')) s.createIndex('name','name',{unique:false}); if(!s.indexNames.contains('school')) s.createIndex('school','school',{unique:false}); if(!s.indexNames.contains('grade_base')) s.createIndex('grade_base','grade_base',{unique:false}); if(!s.indexNames.contains('grade_base_ay')) s.createIndex('grade_base_ay','grade_base_ay',{unique:false});
 var sess; if(!db.objectStoreNames.contains('sessions')){ sess=db.createObjectStore('sessions',{keyPath:'id',autoIncrement:true}); } else { sess=tx.objectStore('sessions'); } if(!sess.indexNames.contains('student_id')) sess.createIndex('student_id','student_id',{unique:false}); if(!sess.indexNames.contains('created_at')) sess.createIndex('created_at','created_at',{unique:false});
 if(!db.objectStoreNames.contains('passages')) db.createObjectStore('passages',{keyPath:'no'});
 if(!db.objectStoreNames.contains('invites')) db.createObjectStore('invites',{keyPath:'token'});
 var g; if(!db.objectStoreNames.contains('guardians')){ g=db.createObjectStore('guardians',{keyPath:'id',autoIncrement:true}); } else { g=tx.objectStore('guardians'); } if(!g.indexNames.contains('student_id')) g.createIndex('student_id','student_id',{unique:false}); };
 r.onsuccess=function(){ db=r.result; res(); }; r.onerror=function(){ rej(r.error); } }); }
function tx(name,mode){ if(!mode) mode='readonly'; return db.transaction(name,mode).objectStore(name); }
var idb={
 addStudent:function(obj){ return new Promise(function(res,rej){ var s={}; for(var k in obj){ s[k]=obj[k]; } if(!s.created_at) s.created_at=Date.now(); var r=tx('students','readwrite').add(s); r.onsuccess=function(){ res(r.result); }; r.onerror=function(){ rej(r.error); }; }); },
 delStudent:function(id){ return new Promise(function(res,rej){ var r=tx('students','readwrite').delete(id); r.onsuccess=function(){ res(); }; r.onerror=function(){ rej(r.error); }; }); },
 listStudents:function(){ return new Promise(function(res,rej){ var out=[]; var c=tx('students').openCursor(); c.onsuccess=function(e){ var cur=e.target.result; if(cur){ var v=cur.value; v.id=cur.primaryKey; out.push(v); cur.continue(); } else { res(out); } }; c.onerror=function(){ rej(c.error); }; }); },
 savePassage:function(no,title,text){ return new Promise(function(res,rej){ var r=tx('passages','readwrite').put({no:String(no),title:title,text:text}); r.onsuccess=function(){ res(); }; r.onerror=function(){ rej(r.error); }; }); },
 delPassage:function(no){ return new Promise(function(res,rej){ var r=tx('passages','readwrite').delete(String(no)); r.onsuccess=function(){ res(); }; r.onerror=function(){ rej(r.error); }; }); },
 getPassage:function(no){ return new Promise(function(res,rej){ var r=tx('passages').get(String(no)); r.onsuccess=function(){ res(r.result||null); }; r.onerror=function(){ rej(r.error); }; }); },
 listPassages:function(){ return new Promise(function(res,rej){ var out=[]; var c=tx('passages').openCursor(); c.onsuccess=function(e){ var cur=e.target.result; if(cur){ out.push(cur.value); cur.continue(); } else { res(out); } }; c.onerror=function(){ rej(c.error); }; }); },
 saveSession:function(s){ return new Promise(function(res,rej){ var r=tx('sessions','readwrite').add(s); r.onsuccess=function(){ res(r.result); }; r.onerror=function(){ rej(r.error); }; }); },
 listSessions:function(studentId,startMs,endMs){ return new Promise(function(res,rej){ var out=[]; var store=tx('sessions'); var req = studentId ? store.index('student_id').openCursor(IDBKeyRange.only(studentId)) : store.openCursor(); req.onsuccess=function(e){ var cur=e.target.result; if(cur){ var v=cur.value; v.id=cur.primaryKey; if((startMs==null||v.created_at>=startMs)&&(endMs==null||v.created_at<endMs)) out.push(v); cur.continue(); } else { out.sort(function(a,b){return b.created_at-a.created_at}); res(out); } }; req.onerror=function(){ rej(req.error); }; }); },
 saveInvite:function(token,student_id,mail){ return new Promise(function(res,rej){ var r=tx('invites','readwrite').put({token:token,student_id:student_id,mail:mail,created_at:Date.now(),used:false}); r.onsuccess=function(){ res(); }; r.onerror=function(){ rej(r.error); }; }); },
 getInvite:function(token){ return new Promise(function(res,rej){ var r=tx('invites').get(token); r.onsuccess=function(){ res(r.result||null); }; r.onerror=function(){ rej(r.error); }; }); },
 useInvite:function(token){ return new Promise(function(res,rej){ var s=tx('invites','readwrite').get(token); s.onsuccess=function(){ var inv=s.result; if(!inv){ res(false); return; } inv.used=true; tx('invites','readwrite').put(inv).onsuccess=function(){ res(true); }; }; s.onerror=function(){ rej(s.error); }; }); },
 addGuardian:function(student_id){ return new Promise(function(res,rej){ var r=tx('guardians','readwrite').add({student_id:student_id,created_at:Date.now()}); r.onsuccess=function(){ res(r.result); }; r.onerror=function(){ rej(r.error); }; }); },
 listGuardiansByStudent:function(student_id){ return new Promise(function(res,rej){ var out=[]; var c=tx('guardians').index('student_id').openCursor(IDBKeyRange.only(student_id)); c.onsuccess=function(e){ var cur=e.target.result; if(cur){ var v=cur.value; v.id=cur.primaryKey; out.push(v); cur.continue(); } else { res(out); } }; c.onerror=function(){ rej(c.error); }; }); }
};

/* ===== Routing & Auth ===== */
function setAutoPref(on){ try{ localStorage.setItem('autojump', on?'1':'0'); }catch(e){} }
function enterRole(role){ try{ var ck=qs('#rememberRole'); if(ck) setAutoPref(ck.checked); localStorage.setItem('last_role', role); }catch(e){}
  if(role==='s') location.hash='#/s'; else if(role==='g') location.hash='#/g'; else if(role==='t') location.hash='#/t'; setActiveTab(); }
function teacherAuthed(){ try{ return localStorage.getItem('teacher_auth')==='1'; }catch(e){ return false; } }
function loginTeacher(){ var id=(qs('#loginId')&&qs('#loginId').value||'').trim(); var pw=(qs('#loginPw')&&qs('#loginPw').value||'').trim(); if(id==='surasura'&&pw==='surasura'){ try{ localStorage.setItem('teacher_auth','1'); }catch(e){} enterRole('t'); } else { alert('IDまたはパスワードが違います'); } }

function setActiveTab(){ var raw=location.hash||'#/start'; var h=raw.split('?')[0]; if(h.indexOf('#/t')===0 && !teacherAuthed()){ h='#/start'; if(location.hash!=='#/start'){ location.hash='#/start'; } }
  var tabs=qsa('a.tab'); tabs.forEach(function(a){a.classList.remove('active')}); if(h.indexOf('#/s')===0) qs('#tabS').classList.add('active'); else if(h.indexOf('#/t')===0) qs('#tabT').classList.add('active'); else if(h.indexOf('#/g')===0) qs('#tabG').classList.add('active');
  var onLanding=(h==='#/start'||h==='#/'); var cover=qs('#landingCover'); if(cover) cover.classList.toggle('hidden', !onLanding); document.body.classList.toggle('landing-active', onLanding);
  qs('#viewS').classList.toggle('hidden', h.indexOf('#/s')!==0);
  qs('#viewT').classList.toggle('hidden', h.indexOf('#/t')!==0);
  qs('#viewG').classList.toggle('hidden', h.indexOf('#/g')!==0);
  if(h.indexOf('#/t')===0) refreshTeacher(); if(h.indexOf('#/g')===0) initGuardianFromToken(); }
window.addEventListener('hashchange', setActiveTab);
setTimeout(function(){ qsa('a.tab').forEach(function(a){ a.addEventListener('click', function(e){ var href=a.getAttribute('href'); if(!href) return; e.preventDefault(); if(href==='#/t'&&!teacherAuthed()){ location.hash='#/start'; setActiveTab(); if(qs('#loginId')) qs('#loginId').focus(); return;} location.hash=href; setActiveTab(); }); }); if(qs('#goS')) qs('#goS').onclick=function(){enterRole('s')}; if(qs('#goG')) qs('#goG').onclick=function(){enterRole('g')}; if(qs('#goSkip')) qs('#goSkip').onclick=function(){enterRole('s')}; if(qs('#loginBtn')) qs('#loginBtn').onclick=loginTeacher; var lid=qs('#loginId'), lpw=qs('#loginPw'); if(lid) lid.addEventListener('keydown',function(e){ if(e.key==='Enter') loginTeacher(); }); if(lpw) lpw.addEventListener('keydown',function(e){ if(e.key==='Enter') loginTeacher(); }); },0);

/* ===== Student: record/analyze ===== */
var mediaStream,audioCtx,analyser,procNode,recorder,recChunks=[],asr,asrActive=false; var voicedMs=0,f0Stats={vals:[],min:9999,max:0}; var viz=qs('#viz'), vctx=viz.getContext('2d');
function drawViz(timeData,f0){ var w=viz.width,h=viz.height; vctx.fillStyle='#0b1322'; vctx.fillRect(0,0,w,h); vctx.strokeStyle='#88aaff'; vctx.beginPath(); for(var i=0;i<timeData.length;i++){ var x=i/timeData.length*w; var y=(timeData[i]/128)*0.45*h + 0.25*h; if(i===0) vctx.moveTo(x,y); else vctx.lineTo(x,y);} vctx.stroke(); vctx.fillStyle='#20e3c2'; var len=Math.min(60,f0.length); for(var k=0;k<len;k++){ var hz=f0[f0.length-len+k]; if(hz>0){ var x2=w - (len-k)*(w/len); var y2=0.75*h + (1 - Math.min(hz,500)/500)*0.25*h; vctx.beginPath(); vctx.arc(x2,y2,2,0,Math.PI*2); vctx.fill(); } } }
function autocorrF0(buf,sr){ var minLag=Math.floor(sr/500),maxLag=Math.floor(sr/70); var bestLag=0,best=0; for(var lag=minLag;lag<=maxLag;lag++){ var c=0; for(var i=0;i<buf.length-lag;i++) c+=buf[i]*buf[i+lag]; if(c>best){best=c;bestLag=lag;} } if(bestLag===0||best<1e-3) return 0; return sr/bestLag; }
async function startRec(){ mediaStream=await navigator.mediaDevices.getUserMedia({audio:true}); recorder=new MediaRecorder(mediaStream); recChunks=[]; recorder.ondataavailable=function(e){ if(e.data.size>0) recChunks.push(e.data); }; recorder.start(); audioCtx=new (window.AudioContext||window.webkitAudioContext)(); var src=audioCtx.createMediaStreamSource(mediaStream); analyser=audioCtx.createAnalyser(); analyser.fftSize=1024; procNode=audioCtx.createScriptProcessor(1024,1,1); var timeBuf=new Uint8Array(analyser.fftSize); var f0Arr=f0Stats.vals=[]; f0Stats.min=9999; f0Stats.max=0; voicedMs=0; procNode.onaudioprocess=function(e){ var ch=e.inputBuffer.getChannelData(0); var rms=0; for(var i=0;i<ch.length;i++) rms+=ch[i]*ch[i]; rms=Math.sqrt(rms/ch.length); if(rms>0.01){ voicedMs+=(ch.length/audioCtx.sampleRate)*1000; var f0=autocorrF0(ch,audioCtx.sampleRate); if(f0>60&&f0<500){ f0Arr.push(f0); if(f0<f0Stats.min) f0Stats.min=f0; if(f0>f0Stats.max) f0Stats.max=f0; } else f0Arr.push(0); } else f0Arr.push(0); analyser.getByteTimeDomainData(timeBuf); drawViz(timeBuf,f0Arr); }; src.connect(analyser); analyser.connect(procNode); procNode.connect(audioCtx.destination); qs('#recStatus').textContent='録音中…'; }
async function stopRec(){ if(recorder && recorder.state!=='inactive') recorder.stop(); if(mediaStream) mediaStream.getTracks().forEach(function(t){t.stop()}); if(procNode) procNode.disconnect(); if(analyser) analyser.disconnect(); if(audioCtx) audioCtx.close(); qs('#recStatus').textContent='停止'; }
function startASR(){ var SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){ alert('このブラウザはWeb Speech APIに未対応です。Chromeをお試しください。'); return false; } asr=new SR(); asr.lang='ja-JP'; asr.interimResults=true; asr.continuous=true; var asrBuf=''; var area=qs('#asrText'); asr.onresult=function(e){ var tmp=''; for(var i=e.resultIndex;i<e.results.length;i++){ var r=e.results[i]; if(r.isFinal) asrBuf+=r[0].transcript; else tmp+=r[0].transcript; } area.value=asrBuf+tmp; }; asr.onend=function(){ asrActive=false; }; asr.start(); asrActive=true; return true; }
function levenshteinAlign(a,b){ var n=a.length,m=b.length,dp=new Array(n+1); for(var i=0;i<=n;i++){ dp[i]=new Array(m+1); dp[i][0]=i; } for(var j=0;j<=m;j++) dp[0][j]=j; for(i=1;i<=n;i++) for(j=1;j<=m;j++){ var cost=a[i-1]===b[j-1]?0:1; var v1=dp[i-1][j]+1, v2=dp[i][j-1]+1, v3=dp[i-1][j-1]+cost; dp[i][j]=Math.min(v1,v2,v3);} var ops=[],ii=n,jj=m; while(ii>0||jj>0){ if(ii>0 && dp[ii][jj]===dp[ii-1][jj]+1){ ops.push({op:'del',ref:a[ii-1],hyp:''}); ii--; } else if(jj>0 && dp[ii][jj]===dp[ii][jj-1]+1){ ops.push({op:'ins',ref:'',hyp:b[jj-1]}); jj--; } else { var op=(a[ii-1]===b[jj-1])?'eq':'sub'; ops.push({op:op,ref:a[ii-1],hyp:b[jj-1]}); ii--; jj--; } } ops.reverse(); return {dist:dp[n][m],ops:ops}; }
function highlightAlign(ops){ var refHtml='',hypHtml=''; for(var k=0;k<ops.length;k++){ var o=ops[k]; if(o.op==='eq'){ refHtml+='<span>'+o.ref+'</span>'; hypHtml+='<span>'+o.hyp+'</span>'; } else if(o.op==='sub'){ refHtml+='<span class="hl-miss">'+o.ref+'</span>'; hypHtml+='<span class="hl-miss">'+o.hyp+'</span>'; } else if(o.op==='del'){ refHtml+='<span class="hl-miss">'+o.ref+'</span>'; hypHtml+='<span>∅</span>'; } else if(o.op==='ins'){ refHtml+='<span>∅</span>'; hypHtml+='<span class="hl-miss">'+o.hyp+'</span>'; } } return {refHtml:refHtml,hypHtml:hypHtml}; }
function arrMean(a){ if(!a.length) return 0; var s=0; for(var i=0;i<a.length;i++) s+=a[i]; return s/a.length; }
function arrSdPos(a){ var v=[],i; for(i=0;i<a.length;i++) if(a[i]>0) v.push(a[i]); var m=arrMean(v), s=0; for(i=0;i<v.length;i++) s+=(v[i]-m)*(v[i]-m); return Math.sqrt(v.length?s/v.length:0); }
function analyzeAll(refRaw,hypRaw,voicedMsLocal,f0){ var ref=normalizeText(refRaw), hyp=normalizeText(hypRaw); var la=levenshteinAlign(ref.split(''),hyp.split('')); var dist=la.dist,ops=la.ops; var cer=ref.length?dist/ref.length:1; var missKanji={}; for(var i=0;i<ops.length;i++){ var o=ops[i]; if((o.op==='sub'||o.op==='del') && isKanji(o.ref)) missKanji[o.ref]=(missKanji[o.ref]||0)+1; } var list=[],k; for(k in missKanji){ list.push([k,missKanji[k]]);} list.sort(function(a,b){return b[1]-a[1]}); var minutes=Math.max(1e-6,voicedMsLocal/60000); var cpm=Math.round(hyp.length/minutes); var f0min=Math.round((f0.min===9999)?0:f0.min), f0max=Math.round(f0.max||0); var f0range=(f0max>0&&f0min>0)?(f0max-f0min):0; var f0sd=Math.round(arrSdPos(f0.vals)); var prosody=0; if(f0range>40) prosody+=10; else if(f0range>20) prosody+=6; else if(f0range>10) prosody+=3; if(f0sd>30) prosody+=10; else if(f0sd>15) prosody+=6; else if(f0sd>8) prosody+=3; if(prosody>20) prosody=20; var acc=Math.max(0,40*(1-cer)); var spd=0; if(cpm>=180&&cpm<=300) spd=20; else if(cpm<180) spd=Math.max(0,20*(cpm/180)); else spd=Math.max(0,20*(1-(cpm-300)/300)); var overall=Math.round(acc+prosody+spd); var hl=highlightAlign(ops); return {cpm:cpm,cer:Number(cer.toFixed(3)),f0range:f0range,prosodyScore:prosody,overall:overall,missKanji:missKanji,missList:list.map(function(x){return x[0]+':'+x[1]}),refHtml:hl.refHtml,hypHtml:hl.hypHtml}; }

/* ===== Student UI ===== */
var currentStudentId=Number(localStorage.getItem('student_id')||0);
function updateStudentBadge(){ if(!currentStudentId){ qs('#studentBadge').textContent='未設定'; return; } idb.listStudents().then(function(l){ var st=null; for(var i=0;i<l.length;i++){ if(l[i].id===currentStudentId){ st=l[i]; break;} } qs('#studentBadge').textContent=st? (st.name+'（'+currentGradeLabel(st)+'）') : '未設定'; }); }
async function chooseStudent(){ var list=await idb.listStudents(); if(!list.length){ alert('まず講師画面（#/t）で生徒を追加してください。'); return; } var lines=[]; for(var i=0;i<list.length;i++){ lines.push('・'+list[i].name+'（'+currentGradeLabel(list[i])+'｜'+(list[i].school||'学校')+'）'); } var name=prompt('生徒名を選んで入力してください\n'+lines.join('\n')); var found=null; for(i=0;i<list.length;i++){ if(list[i].name===name){ found=list[i]; break;} } if(!found){ alert('見つかりませんでした'); return; } currentStudentId=found.id; localStorage.setItem('student_id', String(currentStudentId)); updateStudentBadge(); }
async function loadPassageByNo(no,into){ var p=await idb.getPassage(no); if(!p){ alert('登録されていない番号です'); return; } into.value=p.text||''; if(into===qs('#passageS')) qs('#passageS').scrollTop=0; }
qs('#setStudentBtn').onclick=chooseStudent; qs('#loadPassageBtn').onclick=function(){ var no=qs('#textNo').value.trim(); if(no) loadPassageByNo(no,qs('#passageS')); };
qs('#startBtn').onclick=async function(){ qs('#startBtn').disabled=true; qs('#stopBtn').disabled=false; qs('#saveBtn').disabled=true; qs('#dlAudioBtn').disabled=true; await startRec(); var ok=startASR(); if(!ok){ qs('#startBtn').disabled=false; qs('#stopBtn').disabled=true; } };
qs('#stopBtn').onclick=async function(){ await stopRec(); qs('#startBtn').disabled=false; qs('#stopBtn').disabled=true; qs('#dlAudioBtn').disabled=false; };
qs('#dlAudioBtn').onclick=function(){ if(!recChunks.length) return; var blob=new Blob(recChunks,{type:'audio/webm'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='reading_'+Date.now()+'.webm'; a.click(); };
qs('#analyzeBtn').onclick=function(){ var refRaw=qs('#passageS').value.trim(); var hypRaw=qs('#asrText').value.trim(); if(!refRaw||!hypRaw){ alert('本文と認識結果が必要です'); return; } var r=analyzeAll(refRaw,hypRaw,voicedMs,f0Stats); qs('#speedCpm').textContent=r.cpm; qs('#cer').textContent=r.cer; qs('#f0range').textContent=r.f0range; qs('#prosodyScore').textContent=r.prosodyScore; qs('#overall').textContent=r.overall; qs('#missKanjis').textContent=r.missList.join('　'); qs('#refHl').innerHTML=r.refHtml; qs('#hypHl').innerHTML=r.hypHtml; qs('#scoreStatus').textContent='採点済み'; qs('#saveBtn').disabled=false; qs('#saveBtn').onclick=async function(){ if(!currentStudentId){ alert('この端末の生徒を設定してください'); return; } var no=qs('#textNo').value.trim()||''; var row={created_at:Date.now(),student_id:currentStudentId,text_no:no,cpm:r.cpm,cer:r.cer,f0range:r.f0range,prosodyScore:r.prosodyScore,overall:r.overall,miss_kanji:r.missKanji}; await idb.saveSession(row); qs('#scoreStatus').textContent='保存済み'; alert('保存しました'); }; };

/* ===== Teacher UI ===== */
async function refreshTeacher(){ var list=await idb.listStudents(); var schoolF=(qs('#searchSchool')&&qs('#searchSchool').value.trim())||''; var gradeF=(qs('#searchGrade')&&qs('#searchGrade').value)||''; var filtered=list.filter(function(s){ var okSchool=!schoolF || String(s.school||'').indexOf(schoolF)>=0; var okGrade=!gradeF || (currentGradeNum(s)===Number(gradeF)); return okSchool && okGrade; }); var sel=qs('#studentList'); if(sel){ sel.innerHTML=''; filtered.forEach(function(s){ var o=document.createElement('option'); o.value=s.id; o.textContent=s.name+'（'+currentGradeLabel(s)+'｜'+(s.school||'学校未登録')+'）'; sel.appendChild(o); }); } var gs=qs('#guardianStudent'); if(gs){ gs.innerHTML=''; filtered.forEach(function(s){ var o=document.createElement('option'); o.value=s.id; o.textContent=s.name+'（'+currentGradeLabel(s)+'｜'+(s.school||'学校未登録')+'）'; gs.appendChild(o); }); } await refreshToday(); await listPassages(); }
qs('#addStudentBtn').onclick=async function(){ var name=qs('#studentName').value.trim(); var school=qs('#studentSchool').value.trim(); var gradeLabel=qs('#studentGrade').value; if(!name) return alert('氏名を入れてください'); var s={name:name,school:school,grade:gradeLabel,grade_base:parseGrade(gradeLabel),grade_base_ay:academicYear(new Date())}; await idb.addStudent(s); qs('#studentName').value=''; qs('#studentSchool').value=''; await refreshTeacher(); };
qs('#delStudentBtn').onclick=async function(){ var id=Number(qs('#studentList').value||0); if(!id) return; if(!confirm('この生徒を削除しますか（履歴は残ります）？')) return; await idb.delStudent(id); await refreshTeacher(); };
async function listPassages(){ var t=qs('#passageTable tbody'); if(!t) return; t.innerHTML=''; var rows=await idb.listPassages(); rows.sort(function(a,b){ return String(a.no).localeCompare(String(b.no)); }); rows.forEach(function(r){ var tr=document.createElement('tr'); tr.innerHTML='<td>'+r.no+'</td><td>'+(r.title||'')+'</td><td>'+((r.text||'').slice(0,22))+'…</td>'; tr.onclick=function(){ qs('#textNoT').value=r.no; qs('#titleT').value=r.title||''; qs('#passageT').value=r.text||''; }; t.appendChild(tr); }); }
qs('#savePassageBtn').onclick=async function(){ var no=qs('#textNoT').value.trim(); var title=qs('#titleT').value.trim(); var text=qs('#passageT').value.trim(); if(!no||!text) return alert('番号と本文を入れてください'); await idb.savePassage(no,title,text); await listPassages(); alert('保存/更新しました'); };
qs('#delPassageBtn').onclick=async function(){ var no=qs('#textNoT').value.trim(); if(!no) return; if(!confirm('削除しますか？')) return; await idb.delPassage(no); await listPassages(); };
qs('#listPassagesBtn').onclick=listPassages;

async function refreshToday(){ var today=new Date(); today.setHours(0,0,0,0); var start=today.getTime(), end=start+86400000; var rows=await idb.listSessions(null,start,end); var t=qs('#todayTable tbody'); if(t) t.innerHTML=''; var students=await idb.listStudents(); var sMap=new Map(students.map(function(s){return [s.id,s]})); var aggKanji={}; rows.forEach(function(r){ var st=sMap.get(r.student_id)||{name:'?',grade:'?',school:''}; if(t){ var tr=document.createElement('tr'); tr.innerHTML='<td>'+ymdhm(r.created_at)+'</td><td>'+st.name+'</td><td>'+currentGradeLabel(st)+'</td><td>'+(r.text_no||'')+'</td><td>'+r.cpm+'</td><td>'+r.cer+'</td><td>'+r.f0range+'</td><td>'+r.overall+'</td>'; t.appendChild(tr);} for(var k in (r.miss_kanji||{})){ aggKanji[k]=(aggKanji[k]||0)+r.miss_kanji[k]; } }); var arr=[]; for(var k2 in aggKanji){ arr.push([k2,aggKanji[k2]]);} arr.sort(function(a,b){return b[1]-a[1]}); var kr=qs('#kanjiRankToday'); if(kr) kr.textContent=arr.slice(0,20).map(function(x){return x[0]+':'+x[1]}).join('　'); }
qs('#refreshTodayBtn').onclick=refreshToday; if(qs('#searchStudentsBtn')) qs('#searchStudentsBtn').onclick=refreshTeacher; if(qs('#searchSchool')) qs('#searchSchool').addEventListener('keydown',function(e){ if(e.key==='Enter') refreshTeacher(); }); if(qs('#searchGrade')) qs('#searchGrade').addEventListener('change',refreshTeacher);
qs('#exportCsvBtn').onclick=async function(){ var rows=await idb.listSessions(); var hdr=['datetime','student','grade_current','text_no','cpm','cer','f0range','prosody','overall','miss_kanji_json']; var students=await idb.listStudents(); var sMap=new Map(students.map(function(s){return [s.id,s]})); var lines=[hdr.join(',')]; rows.forEach(function(r){ var st=sMap.get(r.student_id)||{name:'?',grade:'?',school:''}; var miss=JSON.stringify(r.miss_kanji||{}); var vals=[new Date(r.created_at).toISOString(),st.name,currentGradeLabel(st),r.text_no||'',r.cpm,r.cer,r.f0range,r.prosodyScore,r.overall,miss].map(function(v){ return '"'+String(v).replace(/"/g,'""')+'"'; }); lines.push(vals.join(',')); }); var blob=new Blob([lines.join('\n')],{type:'text/csv'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='oral_reading_history.csv'; a.click(); };

/* ===== Guardian ===== */
function randToken(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
qs('#genInviteBtn').onclick=async function(){ var student_id=Number(qs('#guardianStudent').value||0); if(!student_id) return alert('生徒を選択してください'); var mail=(qs('#guardianMail').value||'').trim(); var token=randToken(); await idb.saveInvite(token,student_id,mail); var base=location.href.split('#')[0]; var url=base+'#/g?token='+encodeURIComponent(token); qs('#inviteLink').value=url; if(navigator.clipboard) navigator.clipboard.writeText(url).catch(function(){}); var stList=await idb.listStudents(); var st=null; for(var i=0;i<stList.length;i++){ if(stList[i].id===student_id){ st=stList[i]; break; } }
 var subj='【招待】音読結果閲覧'; var body=(st?st.name:'お子さま')+'の音読結果はこちら：\n'+url+'\n\n※端末のホーム画面に追加しておくと便利です。'; qs('#mailtoBtn').href='mailto:'+encodeURIComponent(mail)+'?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(body); alert('招待リンクを作成しました。メールに貼り付けて送ってください。'); };
qs('#copyInviteBtn').onclick=function(){ var i=qs('#inviteLink'); i.select(); document.execCommand('copy'); };
async function initGuardianFromToken(){ var hash=location.hash||''; var parts=hash.split('?'); var q=(parts[1]||''); var params=new URLSearchParams(q); var token=params.get('token'); if(token){ var inv=await idb.getInvite(token); if(inv && !inv.used){ await idb.addGuardian(inv.student_id); await idb.useInvite(token); qs('#guardianBind').textContent='この端末は招待によりお子さまと連携されました。'; localStorage.setItem('guardian_student_id', String(inv.student_id)); } } var sid=Number(localStorage.getItem('guardian_student_id')||0); if(!sid){ qs('#gStudent').textContent='未連携'; return; } var stList=await idb.listStudents(); var st=null; for(var i=0;i<stList.length;i++){ if(stList[i].id===sid){ st=stList[i]; break; } } qs('#gStudent').textContent=st? (st.name+'（'+currentGradeLabel(st)+'）') : '未連携'; var today=new Date(); today.setHours(0,0,0,0); var rows=await idb.listSessions(sid,today.getTime(),today.getTime()+86400000); var tb=qs('#gTable tbody'); if(tb) tb.innerHTML=''; rows.forEach(function(r){ var tr=document.createElement('tr'); tr.innerHTML='<td>'+ymdhm(r.created_at)+'</td><td>'+(r.text_no||'')+'</td><td>'+r.cpm+'</td><td>'+r.cer+'</td><td>'+r.overall+'</td>'; if(tb) tb.appendChild(tr); }); }
qs('#gInstallBtn').onclick=function(){ alert('ホーム画面に追加:\n1) メニュー（⋮ / 共有）→「ホーム画面に追加」\n2) 追加後はそのアイコンから起動できます。'); };

/* ===== Init ===== */
async function init(){ try{ await openDB(); } catch(e){ log('IndexedDB error:', e); alert('初期化に失敗しました。読み取り専用で続行します。'); }
 if('serviceWorker' in navigator){ var ENABLE_SW = !location.hostname.endsWith('github.io'); if(ENABLE_SW){ var swLines=[
  "self.addEventListener('install',e=>{ e.waitUntil(caches.open('oral-roles-v0210').then(c=>c.addAll(['./']))); });",
  "self.addEventListener('fetch',e=>{ e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))); });"
 ]; var blob=new Blob([swLines.join('\n')],{type:'text/javascript'}); try{ await navigator.serviceWorker.register(URL.createObjectURL(blob)); log('SW registered'); }catch(e){ log('SW failed',e); } } else { log('ServiceWorker disabled on github.io'); } }
 try{ var ps=await idb.listPassages(); if(!ps.length){ await idb.savePassage('1001','春の川辺','春の川辺を歩くと、冷たい風の中にも、少しずつあたたかさが感じられます。土手の草むらには、小さな花が顔を出し、川の流れはきらきらと光っています。ぼくは、遠くで鳴く鳥の声を聞きながら、ゆっくりと足もとを確かめて歩きました。'); await idb.savePassage('1002','夏の入道雲','夏の午後、空には大きな入道雲がむくむくと立ちのぼります。ひまわりの花は太陽を見上げ、遠くからは祭りの笛の音が聞こえてきます。わたしは汗をふきながらも、どこかうきうきした気持ちになりました。'); } }catch(e){ log('seed error',e); }
 // autojump
 try{ var auto=localStorage.getItem('autojump')==='1'; var last=localStorage.getItem('last_role'); var atStart=(!location.hash||location.hash==='#'||location.hash==='#/'||location.hash==='#/start'); if(auto && atStart && last){ if(last==='t'){ if(teacherAuthed()) location.hash='#/t'; } else if(last==='s') location.hash='#/s'; else if(last==='g') location.hash='#/g'; } }catch(e){}
 setActiveTab(); selfTest(); }
setActiveTab(); init().catch(function(e){ log('init failed:', e); });

/* ===== Self tests ===== */
function assert(cond,msg){ if(!cond){ console.error('[TEST] FAIL:',msg); log('[TEST] FAIL:',msg); } else { console.log('[TEST] OK:',msg); log('[TEST] OK:',msg); } }
function selfTest(){ assert(!!qs('#goS') && !!qs('#goG') && !!qs('#loginBtn'),'Landing controls present'); location.hash='#/start'; setActiveTab(); assert(!qs('#landingCover').classList.contains('hidden') && document.body.classList.contains('landing-active'),'Landing overlay visible'); location.hash='#/s'; setActiveTab(); assert(qs('#landingCover').classList.contains('hidden') && !document.body.classList.contains('landing-active'),'Landing overlay hidden'); assert(typeof startRec==='function' && typeof startASR==='function','Recording functions exist'); assert(typeof analyzeAll==='function','Analyze function exists'); location.hash='#/t'; setActiveTab(); assert(qs('#viewT').classList.contains('hidden'),'Teacher guard works'); var old=localStorage.getItem('teacher_auth'); localStorage.setItem('teacher_auth','1'); location.hash='#/t'; setActiveTab(); assert(!qs('#viewT').classList.contains('hidden'),'Teacher shows after auth'); if(old==null) localStorage.removeItem('teacher_auth'); else localStorage.setItem('teacher_auth',old); idb.listPassages().then(function(r){ assert(Array.isArray(r),'Passages can list'); }); }
</script>
</body>
</html>
